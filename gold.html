<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø°Ù‡Ø¨</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container" id="app" style="display:none">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸª™ ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨</h1>
      <p class="small" id="goldPriceText">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±...</p>
      <p class="small" id="goldPricesSmall"></p>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³Ù… -->
  <div class="card">
    <iframe
      src="https://s.tradingview.com/widgetembed/?symbol=OANDA:XAUUSD&interval=15&theme=dark"
      style="width:100%;height:300px;border:none;border-radius:12px">
    </iframe>
  </div>

  <!-- Ø§Ù„Ø±ØµÙŠØ¯ -->
  <div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ</h3>
    <div id="balances">...</div>
    <div id="pnlBox" class="small"></div>
  </div>

  <!-- Ø´Ø±Ø§Ø¡ -->
  <div class="card">
    <h3>ğŸŸ¢ Ø´Ø±Ø§Ø¡ Ø°Ù‡Ø¨</h3>
    <input id="buyPoints" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">
    <button id="buyBtn" class="btn btn-primary">Ø´Ø±Ø§Ø¡</button>
    <div id="buyHint" class="small"></div>
  </div>

  <!-- Ø¨ÙŠØ¹ -->
  <div class="card">
    <h3>ğŸ”´ Ø¨ÙŠØ¹ Ø°Ù‡Ø¨</h3>
    <input id="sellGrams" type="number" step="0.0001" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ø§Ù…Ø§Øª">
    <button id="sellBtn" class="btn btn-danger">Ø¨ÙŠØ¹</button>
    <div id="sellHint" class="small"></div>
  </div>

  <!-- Ø§Ù„Ø³Ø¬Ù„ -->
  <div class="card">
    <h3>ğŸ“œ Ø³Ø¬Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h3>
    <div id="history">...</div>
  </div>

</div>

<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ </a>
    <a class="nav-item active" href="gold.html">ğŸª™</a>
    <a class="nav-item" href="wallet.html">ğŸ‘›</a>
    <a class="nav-item" href="profile.html">ğŸ‘¤</a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

const GOLD_API_KEY = "goldapi-fmnsmjkdy7yt-io";
const MIN_ACTIVATION = 500;

let basePrice = 0;
let buyPrice = 0;
let sellPrice = 0;

/* ===== Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
const { data:{user} } = await supabase.auth.getUser();
if (!user) location.href = "login.html";

/* ===== ÙØ­Øµ Ø§Ù„ØªÙØ¹ÙŠÙ„ ===== */
const { data:walletCheck } = await supabase
  .from("wallets")
  .select("points, gold_enabled")
  .eq("user_id", user.id)
  .single();

if (!walletCheck || (!walletCheck.gold_enabled && walletCheck.points < MIN_ACTIVATION)) {
  document.body.innerHTML = "<h2 style='text-align:center;margin-top:80px'>ğŸ”’ Ø§Ù„Ø°Ù‡Ø¨ Ù…Ù‚ÙÙ„</h2>";
  throw new Error("Gold locked");
}

document.getElementById("app").style.display = "block";

/* ===== Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ ===== */
async function loadPrice(){
  const r = await fetch("https://www.goldapi.io/api/XAU/USD",{
    headers:{ "x-access-token": GOLD_API_KEY }
  });
  const d = await r.json();

  basePrice = d.price_gram_24k;
  buyPrice  = basePrice * 1.01;
  sellPrice = basePrice * 0.99;

  goldPriceText.innerHTML = `Ø§Ù„Ø³Ø¹Ø±: <b>${basePrice.toFixed(2)}</b>`;
  goldPricesSmall.innerHTML = `Ø´Ø±Ø§Ø¡ ${buyPrice.toFixed(2)} | Ø¨ÙŠØ¹ ${sellPrice.toFixed(2)}`;
  buyHint.innerText = `ÙƒÙ„ ${buyPrice.toFixed(2)} Ù†Ù‚Ø·Ø© = 1 Øº`;
  sellHint.innerText = `1 Øº = ${sellPrice.toFixed(2)} Ù†Ù‚Ø·Ø©`;
}

/* ===== Ø§Ù„Ø£Ø±ØµØ¯Ø© ===== */
async function loadBalances(){
  const { data:w } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  let { data:g } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  if (!g) {
    await supabase.from("gold_wallets").insert({ user_id:user.id, grams:0 });
    g = { grams:0 };
  }

  balances.innerHTML = `ğŸ’° Ø§Ù„Ù†Ù‚Ø§Ø·: ${w.points.toFixed(2)}<br>ğŸª™ Ø§Ù„Ø°Ù‡Ø¨: ${g.grams.toFixed(4)} Øº`;
}

/* ===== Ø´Ø±Ø§Ø¡ ===== */
buyBtn.onclick = async ()=>{
  const points = Number(buyPoints.value);
  if (!points || points <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­Ø©");

  const grams = points / buyPrice;

  const { data:w } = await supabase.from("wallets").select("points").eq("user_id",user.id).single();
  const { data:g } = await supabase.from("gold_wallets").select("grams").eq("user_id",user.id).single();

  if (w.points < points) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await supabase.from("wallets").update({ points: w.points - points }).eq("user_id",user.id);
  await supabase.from("gold_wallets").update({ grams: g.grams + grams }).eq("user_id",user.id);

  await supabase.from("gold_trades").insert({
    user_id:user.id, type:"buy", grams, price:buyPrice, points
  });

  loadBalances(); loadHistory();
};

/* ===== Ø¨ÙŠØ¹ ===== */
sellBtn.onclick = async ()=>{
  const grams = Number(sellGrams.value);
  if (!grams || grams <= 0) return alert("Ø£Ø¯Ø®Ù„ ØºØ±Ø§Ù…Ø§Øª ØµØ­ÙŠØ­Ø©");

  const points = grams * sellPrice;

  const { data:w } = await supabase.from("wallets").select("points").eq("user_id",user.id).single();
  const { data:g } = await supabase.from("gold_wallets").select("grams").eq("user_id",user.id).single();

  if (g.grams < grams) return alert("Ø±ØµÙŠØ¯ Ø§Ù„Ø°Ù‡Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await supabase.from("gold_wallets").update({ grams: g.grams - grams }).eq("user_id",user.id);
  await supabase.from("wallets").update({ points: w.points + points }).eq("user_id",user.id);

  await supabase.from("gold_trades").insert({
    user_id:user.id, type:"sell", grams, price:sellPrice, points
  });

  loadBalances(); loadHistory();
};

/* ===== Ø§Ù„Ø³Ø¬Ù„ ===== */
async function loadHistory(){
  const { data } = await supabase
    .from("gold_trades")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at",{ascending:false});

  history.innerHTML = data.map(t=>`
    <div class="small">
      ${t.type==="buy"?"ğŸŸ¢":"ğŸ”´"} ${t.grams.toFixed(4)} Øº â€”
      ${t.points.toFixed(2)} Ù†Ù‚Ø·Ø©
    </div>
  `).join("");
}

await loadPrice();
await loadBalances();
await loadHistory();
setInterval(loadPrice,10000);
</script>

</body>
</html>
