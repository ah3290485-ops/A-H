<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø°Ù‡Ø¨</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container" id="app" style="display:none">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸª™ ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨</h1>
      <p class="small" id="goldPriceText">Ø³Ø¹Ø± Ø§Ù„ØºØ±Ø§Ù…: ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>
  <!-- Ø±Ø³Ù… Ø´Ù…ÙˆØ¹ Ø§Ù„Ø°Ù‡Ø¨ -->
<div class="card">
  <h3>ğŸ“Š Ø±Ø³Ù… Ø§Ù„Ø°Ù‡Ø¨ (Ø´Ù…ÙˆØ¹)</h3>

  <div style="height:360px">
    <iframe
      src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_xauusd
      &symbol=OANDA:XAUUSD
      &interval=15
      &hidesidetoolbar=1
      &hidetoptoolbar=1
      &theme=dark
      &style=1
      &locale=ar"
      style="width:100%;height:100%;border:none;border-radius:12px;"
      loading="lazy">
    </iframe>
  </div>
</div>

  <!-- Ø§Ù„Ø±ØµÙŠØ¯ -->
  <div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ</h3>
    <div id="balances">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø´Ø±Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨ -->
  <div class="card">
    <h3>ğŸŸ¢ Ø´Ø±Ø§Ø¡ Ø°Ù‡Ø¨</h3>
    <input id="buyPoints" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">
    <div style="height:10px"></div>
    <button id="buyBtn" class="btn btn-primary">Ø´Ø±Ø§Ø¡</button>
  </div>

  <!-- Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨ -->
  <div class="card">
    <h3>ğŸ”´ Ø¨ÙŠØ¹ Ø°Ù‡Ø¨</h3>
    <input id="sellGrams" type="number" step="0.01" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ø§Ù…Ø§Øª">
    <div style="height:10px"></div>
    <button id="sellBtn" class="btn btn-danger">Ø¨ÙŠØ¹</button>
  </div>

  <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
  <div class="card">
    <h3>ğŸ“œ Ø³Ø¬Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h3>
    <div id="history">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a class="nav-item active" href="gold.html">ğŸª™<div>Ø§Ù„Ø°Ù‡Ø¨</div></a>
    <a class="nav-item" href="wallet.html">ğŸ‘›<div>Ù…Ø­ÙØ¸ØªÙŠ</div></a>
    <a class="nav-item" href="profile.html">ğŸ‘¤<div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =====================
   Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
===================== */
let GOLD_PRICE = 135; // Ø§Ø­ØªÙŠØ§Ø·ÙŠ
const MIN_ACTIVATION = 500;
const GOLD_API_KEY = "goldapi-fmnsmjkdy7yt-io";

/* =====================
   ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
===================== */
const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";

/* =====================
   Ù‚ÙÙ„ Ø§Ù„Ø°Ù‡Ø¨
===================== */
const { data: walletCheck } = await supabase
  .from("wallets")
  .select("points, gold_enabled")
  .eq("user_id", user.id)
  .single();

if (
  !walletCheck ||
  (!walletCheck.gold_enabled && walletCheck.points < MIN_ACTIVATION)
) {
  document.body.innerHTML = `
    <div style="
      max-width:420px;
      margin:80px auto;
      background:#111;
      padding:20px;
      border-radius:14px;
      text-align:center;
      color:#fff
    ">
      <h2>ğŸ”’ Ø§Ù„Ø°Ù‡Ø¨ Ù…Ù‚ÙÙ„</h2>
      <p style="opacity:.85">
        ÙŠØ¬Ø¨ Ø´Ø­Ù† <b>50 Ø¯ÙˆÙ„Ø§Ø±</b> Ø£Ùˆ Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
      </p>
      <a href="wallet.html"
         style="
           display:inline-block;
           margin-top:15px;
           padding:10px 18px;
           background:#d4af37;
           color:#000;
           border-radius:30px;
           text-decoration:none;
           font-weight:700
         ">
         ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø¢Ù†
      </a>
    </div>
  `;
  throw new Error("Gold locked");
}

/* =====================
   ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
===================== */
document.getElementById("app").style.display = "block";

/* =====================
   ØªØ­Ù…ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
===================== */
async function loadGoldPrice() {
  try {
    const res = await fetch("https://www.goldapi.io/api/XAU/USD", {
      headers: {
        "x-access-token": GOLD_API_KEY,
        "Content-Type": "application/json"
      }
    });
    const data = await res.json();
    GOLD_PRICE = data.price_gram_24k;

    document.getElementById("goldPriceText").innerHTML =
      `Ø³Ø¹Ø± Ø§Ù„ØºØ±Ø§Ù… (24K): <b>${GOLD_PRICE.toFixed(2)} Ù†Ù‚Ø·Ø©</b>`;
  } catch (e) {
    console.error("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±", e);
  }
}

/* =====================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©
===================== */
async function loadBalances() {
  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  let { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  if (!gold) {
    await supabase.from("gold_wallets").insert({
      user_id: user.id,
      grams: 0
    });
    gold = { grams: 0 };
  }

  document.getElementById("balances").innerHTML = `
    ğŸ’° Ø§Ù„Ù†Ù‚Ø§Ø·: <b>${wallet.points}</b><br>
    ğŸª™ Ø§Ù„Ø°Ù‡Ø¨: <b>${gold.grams.toFixed(2)} Øº</b>
  `;
}

/* =====================
   Ø´Ø±Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨
===================== */
document.getElementById("buyBtn").onclick = async () => {
  const points = Number(document.getElementById("buyPoints").value);
  if (!points || points <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­Ø©");

  const grams = points / GOLD_PRICE;

  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  if (wallet.points < points) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  const { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  await supabase.from("wallets")
    .update({ points: wallet.points - points })
    .eq("user_id", user.id);

  await supabase.from("gold_wallets")
    .update({ grams: gold.grams + grams })
    .eq("user_id", user.id);

  await supabase.from("gold_trades").insert({
    user_id: user.id,
    type: "buy",
    grams,
    price: GOLD_PRICE
  });

  alert("âœ… ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨");
  loadBalances();
  loadHistory();
};

/* =====================
   Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨
===================== */
document.getElementById("sellBtn").onclick = async () => {
  const grams = Number(document.getElementById("sellGrams").value);
  if (!grams || grams <= 0) return alert("Ø£Ø¯Ø®Ù„ ØºØ±Ø§Ù…Ø§Øª ØµØ­ÙŠØ­Ø©");

  const points = grams * GOLD_PRICE;

  const { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  if (gold.grams < grams) return alert("Ø±ØµÙŠØ¯ Ø§Ù„Ø°Ù‡Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  await supabase.from("gold_wallets")
    .update({ grams: gold.grams - grams })
    .eq("user_id", user.id);

  await supabase.from("wallets")
    .update({ points: wallet.points + points })
    .eq("user_id", user.id);

  await supabase.from("gold_trades").insert({
    user_id: user.id,
    type: "sell",
    grams,
    price: GOLD_PRICE
  });

  alert("âœ… ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨");
  loadBalances();
  loadHistory();
};

/* =====================
   Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
===================== */
async function loadHistory() {
  const box = document.getElementById("history");
  const { data } = await supabase
    .from("gold_trades")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(t => {
    box.innerHTML += `
      <div class="small">
        ${t.type === "buy" ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : "ğŸ”´ Ø¨ÙŠØ¹"} â€”
        ${t.grams.toFixed(2)} Øº â€”
        ${t.price.toFixed(2)} Ù†Ù‚Ø·Ø©
        <br>
        <small>${new Date(t.created_at).toLocaleString()}</small>
        <hr>
      </div>
    `;
  });
}

/* ØªØ´ØºÙŠÙ„ */
loadGoldPrice();
loadBalances();
loadHistory();
</script>

</body>
</html>
