<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø°Ù‡Ø¨</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container" id="app" style="display:none">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸª™ ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨</h1>
      <p class="small" id="goldPriceText">Ø³Ø¹Ø± Ø§Ù„ØºØ±Ø§Ù…: ØªØ­Ù…ÙŠÙ„...</p>
      <p class="small" id="goldPricesSmall" style="opacity:.8">â€”</p>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³Ù… -->
  <div class="card">
    <h3>ğŸ“Š Ø±Ø³Ù… Ø§Ù„Ø°Ù‡Ø¨ (Ø´Ù…ÙˆØ¹)</h3>
    <div style="height:360px">
      <iframe
        src="https://s.tradingview.com/widgetembed/?symbol=OANDA:XAUUSD&interval=15&theme=dark&style=1&locale=ar"
        style="width:100%;height:100%;border:none;border-radius:12px;">
      </iframe>
    </div>
  </div>

  <!-- Ø§Ù„Ø±ØµÙŠØ¯ -->
  <div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ</h3>
    <div id="balances">ØªØ­Ù…ÙŠÙ„...</div>
    <div id="pnlBox" class="small" style="margin-top:10px"></div>
  </div>

  <!-- Ø´Ø±Ø§Ø¡ -->
  <div class="card">
    <h3>ğŸŸ¢ Ø´Ø±Ø§Ø¡ Ø°Ù‡Ø¨</h3>
    <input id="buyPoints" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">
    <button id="buyBtn" class="btn btn-primary">Ø´Ø±Ø§Ø¡</button>
    <div id="buyHint" class="small"></div>
  </div>

  document.getElementById("sellBtn").onclick = async () => {
  if (!tradingEnabled) {
    alert("â›” Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹");
    return;
  }

  const gramsToSell = Number(document.getElementById("sellGrams").value);
  if (!gramsToSell || gramsToSell <= 0) {
    alert("âŒ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØºØ±Ø§Ù…Ø§Øª ØµØ­ÙŠØ­");
    return;
  }

  // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³Ø¹Ø± Ø¬Ø§Ù‡Ø²
  if (!sellPrice || !isFinite(sellPrice)) {
    alert("âŒ Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„");
    return;
  }

  const pointsBack = Number((gramsToSell * sellPrice).toFixed(6));
  if (!isFinite(pointsBack) || pointsBack <= 0) {
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹");
    return;
  }

  // ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  if (!gold || Number(gold.grams) < gramsToSell) {
    alert("âŒ Ø±ØµÙŠØ¯ Ø§Ù„Ø°Ù‡Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠ");
    return;
  }

  // ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  const currentPoints = Number(wallet?.points || 0);
  const newPoints = Number((currentPoints + pointsBack).toFixed(6));

  // Ø®ØµÙ… Ø§Ù„Ø°Ù‡Ø¨
  await supabase
    .from("gold_wallets")
    .update({
      grams: Number((gold.grams - gramsToSell).toFixed(6))
    })
    .eq("user_id", user.id);

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· (Ø¢Ù…Ù†)
  await supabase
    .from("wallets")
    .update({
      points: newPoints
    })
    .eq("user_id", user.id);

  // Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  await supabase.from("gold_trades").insert({
    user_id: user.id,
    type: "sell",
    grams: gramsToSell,
    price: sellPrice,
    points: pointsBack
  });

  alert("âœ… ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨ Ø¨Ù†Ø¬Ø§Ø­");

  document.getElementById("sellGrams").value = "";

  await loadBalances();
  await loadHistory();
  await loadPnL();
};

  <!-- Ø³Ø¬Ù„ -->
  <div class="card">
    <h3>ğŸ“œ Ø³Ø¬Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h3>
    <div id="history">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

</div>

<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a class="nav-item active" href="gold.html">ğŸª™<div>Ø§Ù„Ø°Ù‡Ø¨</div></a>
    <a class="nav-item" href="wallet.html">ğŸ‘›<div>Ù…Ø­ÙØ¸ØªÙŠ</div></a>
    <a class="nav-item" href="profile.html">ğŸ‘¤<div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

const GOLD_API_KEY = "goldapi-fmnsmjkdy7yt-io";
const MIN_ACTIVATION = 500;

let basePrice = 135;
let buyPrice = 135;
let sellPrice = 135;

/* ===== Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ===== */
function maskEmail(email) {
  if (!email) return "us*****@mail.com";
  const [n,d] = email.split("@");
  return n.slice(0,2) + "*****" + n.slice(-1) + "@" + d;
}

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
const { data:{user} } = await supabase.auth.getUser();
if (!user) location.href = "login.html";

/* ===== Ù‚ÙÙ„ Ø§Ù„Ø°Ù‡Ø¨ ===== */
const { data:wallet } = await supabase
  .from("wallets")
  .select("points, gold_enabled")
  .eq("user_id", user.id)
  .single();

if (!wallet || (!wallet.gold_enabled && wallet.points < MIN_ACTIVATION)) {
  document.body.innerHTML = `<h2 style="text-align:center;margin-top:80px">ğŸ”’ Ø§Ù„Ø°Ù‡Ø¨ Ù…Ù‚ÙÙ„</h2>`;
  throw new Error("Gold locked");
}

document.getElementById("app").style.display = "block";

/* ===== Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ ===== */
async function loadPrice(){
  const r = await fetch("https://www.goldapi.io/api/XAU/USD",{
    headers:{"x-access-token":GOLD_API_KEY}
  });
  const d = await r.json();
  basePrice = d.price_gram_24k;
  buyPrice = basePrice * 1.01;
  sellPrice = basePrice * 0.99;

  goldPriceText.innerHTML = `Ø³Ø¹Ø± Ø§Ù„ØºØ±Ø§Ù…: <b>${basePrice.toFixed(2)}</b>`;
  goldPricesSmall.innerHTML = `Ø´Ø±Ø§Ø¡ ${buyPrice.toFixed(2)} | Ø¨ÙŠØ¹ ${sellPrice.toFixed(2)}`;
  buyHint.innerText = `ÙƒÙ„ ${buyPrice.toFixed(2)} Ù†Ù‚Ø·Ø© = 1 Øº`;
  sellHint.innerText = `1 Øº = ${sellPrice.toFixed(2)} Ù†Ù‚Ø·Ø©`;
}

/* ===== Ø§Ù„Ø£Ø±ØµØ¯Ø© ===== */
async function loadBalances(){
  const { data:w } = await supabase.from("wallets").select("points").eq("user_id",user.id).single();
  let { data:g } = await supabase.from("gold_wallets").select("grams").eq("user_id",user.id).single();
  if(!g){
    await supabase.from("gold_wallets").insert({user_id:user.id,grams:0});
    g={grams:0};
  }
  balances.innerHTML = `ğŸ’° Ø§Ù„Ù†Ù‚Ø§Ø·: ${w.points}<br>ğŸª™ Ø§Ù„Ø°Ù‡Ø¨: ${g.grams.toFixed(4)} Øº`;
}

/* ===== Ø´Ø±Ø§Ø¡ ===== */
buyBtn.onclick = async ()=>{
  const points = Number(buyPoints.value);
  const grams = points / buyPrice;
  await supabase.from("wallets").update({points:wallet.points - points}).eq("user_id",user.id);
  await supabase.from("gold_wallets").update({grams:grams}).eq("user_id",user.id);
  await supabase.from("gold_trades").insert({user_id:user.id,type:"buy",grams,price:buyPrice,points});
  await supabase.from("public_activity").insert({
    user_id:user.id,
    email:maskEmail(user.email),
    action:"Ø´Ø±Ø§Ø¡ Ø°Ù‡Ø¨",
    amount:grams
  });
  alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡");
  loadBalances(); loadHistory();
};

/* ===== Ø¨ÙŠØ¹ ===== */
sellBtn.onclick = async ()=>{
  const grams = Number(sellGrams.value);
  const points = grams * sellPrice;
  await supabase.from("gold_wallets").update({grams:0}).eq("user_id",user.id);
  await supabase.from("wallets").update({points:wallet.points + points}).eq("user_id",user.id);
  await supabase.from("gold_trades").insert({user_id:user.id,type:"sell",grams,price:sellPrice,points});
  await supabase.from("public_activity").insert({
    user_id:user.id,
    email:maskEmail(user.email),
    action:"Ø¨ÙŠØ¹ Ø°Ù‡Ø¨",
    amount:grams
  });
  alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹");
  loadBalances(); loadHistory();
};

/* ===== Ø§Ù„Ø³Ø¬Ù„ ===== */
async function loadHistory(){
  const { data } = await supabase.from("gold_trades").select("*").eq("user_id",user.id).order("created_at",{ascending:false});
  history.innerHTML = data.map(t=>`
    <div>${t.type==="buy"?"ğŸŸ¢":"ğŸ”´"} ${t.grams.toFixed(4)} Øº â€” ${t.points} Ù†Ù‚Ø·Ø©</div>
  `).join("");
}

await loadPrice();
await loadBalances();
await loadHistory();
setInterval(loadPrice,10000);
</script>
</body>
</html>
