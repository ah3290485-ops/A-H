<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø°Ù‡Ø¨</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container" id="app" style="display:none">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸª™ ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨</h1>
      <p class="small" id="goldPriceText">Ø³Ø¹Ø± Ø§Ù„ØºØ±Ø§Ù…: ØªØ­Ù…ÙŠÙ„...</p>
      <p class="small" id="goldPricesSmall" style="opacity:.8">â€”</p>
    </div>
  </div>

  <!-- Ø±Ø³Ù… Ø´Ù…ÙˆØ¹ (Ø¹Ø±Ø¶ ÙÙ‚Ø·) -->
  <div class="card">
    <h3>ğŸ“Š Ø±Ø³Ù… Ø§Ù„Ø°Ù‡Ø¨ (Ø´Ù…ÙˆØ¹)</h3>
    <div style="height:360px">
      <iframe
        src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_xauusd&symbol=OANDA:XAUUSD&interval=15&hidesidetoolbar=1&hidetoptoolbar=1&theme=dark&style=1&locale=ar"
        style="width:100%;height:100%;border:none;border-radius:12px;"
        loading="lazy">
      </iframe>
    </div>
    <div class="small" style="opacity:.7;margin-top:8px">
      Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ Ù„Ù„ØªØ¯Ø§ÙˆÙ„: Ù…Ù† GoldAPI (Live)
    </div>
  </div>

  <!-- Ø§Ù„Ø±ØµÙŠØ¯ + Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© -->
  <div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ</h3>
    <div id="balances">ØªØ­Ù…ÙŠÙ„...</div>
    <div style="height:10px"></div>
    <div class="small" id="pnlBox" style="padding:10px;border-radius:12px;background:rgba(255,255,255,.04)">
      ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©...
    </div>
  </div>

  <!-- Ø´Ø±Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨ -->
  <div class="card">
    <h3>ğŸŸ¢ Ø´Ø±Ø§Ø¡ Ø°Ù‡Ø¨</h3>
    <input id="buyPoints" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">
    <div style="height:10px"></div>
    <button id="buyBtn" class="btn btn-primary">Ø´Ø±Ø§Ø¡</button>
    <div class="small" id="buyHint" style="margin-top:8px;opacity:.8">â€”</div>
  </div>

  <!-- Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨ -->
  <div class="card">
    <h3>ğŸ”´ Ø¨ÙŠØ¹ Ø°Ù‡Ø¨</h3>
    <input id="sellGrams" type="number" step="0.01" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ø§Ù…Ø§Øª">
    <div style="height:10px"></div>
    <button id="sellBtn" class="btn btn-danger">Ø¨ÙŠØ¹</button>
    <div class="small" id="sellHint" style="margin-top:8px;opacity:.8">â€”</div>
  </div>

  <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
  <div class="card">
    <h3>ğŸ“œ Ø³Ø¬Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h3>
    <div id="history">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a class="nav-item active" href="gold.html">ğŸª™<div>Ø§Ù„Ø°Ù‡Ø¨</div></a>
    <a class="nav-item" href="wallet.html">ğŸ‘›<div>Ù…Ø­ÙØ¸ØªÙŠ</div></a>
    <a class="nav-item" href="profile.html">ğŸ‘¤<div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =====================
   Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
===================== */
const MIN_ACTIVATION = 500;
const GOLD_API_KEY = "goldapi-fmnsmjkdy7yt-io";

let basePrice = 135;        // Ø³Ø¹Ø± ØºØ±Ø§Ù… 24K Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
let buyPrice = 135;         // Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø¨Ø±ÙŠØ¯
let sellPrice = 135;        // Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø¨Ø±ÙŠØ¯
let spreadBuyPercent = 0;
let spreadSellPercent = 0;
let tradingEnabled = true;

/* =====================
   ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
===================== */
const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";

/* =====================
   Ù‚ÙÙ„ Ø§Ù„Ø°Ù‡Ø¨ Ø­ØªÙ‰ 500$ Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
===================== */
const { data: walletCheck, error: wcErr } = await supabase
  .from("wallets")
  .select("points, gold_enabled")
  .eq("user_id", user.id)
  .single();

if (wcErr || !walletCheck || (!walletCheck.gold_enabled && Number(walletCheck.points || 0) < MIN_ACTIVATION)) {
  document.body.innerHTML = `
    <div style="
      max-width:420px;
      margin:80px auto;
      background:#111;
      padding:20px;
      border-radius:14px;
      text-align:center;
      color:#fff
    ">
      <h2>ğŸ”’ Ø§Ù„Ø°Ù‡Ø¨ Ù…Ù‚ÙÙ„</h2>
      <p style="opacity:.85">
        ÙŠØ¬Ø¨ Ø´Ø­Ù† <b>500 Ø¯ÙˆÙ„Ø§Ø±</b> Ø£Ùˆ Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
      </p>
      <a href="wallet.html"
         style="
           display:inline-block;
           margin-top:15px;
           padding:10px 18px;
           background:#d4af37;
           color:#000;
           border-radius:30px;
           text-decoration:none;
           font-weight:700
         ">
         ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø¢Ù†
      </a>
    </div>
  `;
  throw new Error("Gold locked");
}

/* =====================
   ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
===================== */
document.getElementById("app").style.display = "block";

/* =====================
   ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°Ù‡Ø¨
===================== */
async function loadGoldSettings() {
  const { data } = await supabase
    .from("gold_settings")
    .select("trading_enabled, spread_buy_percent, spread_sell_percent")
    .eq("id", 1)
    .single();

  if (data) {
    tradingEnabled = data.trading_enabled;
    spreadBuyPercent = Number(data.spread_buy_percent || 0);
    spreadSellPercent = Number(data.spread_sell_percent || 0);
  }
}

/* =====================
   ØªØ­Ù…ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
===================== */
async function loadGoldPrice() {
  try {
    const res = await fetch("https://www.goldapi.io/api/XAU/USD", {
      headers: {
        "x-access-token": GOLD_API_KEY,
        "Content-Type": "application/json"
      }
    });

    const data = await res.json();
    if (data && data.price_gram_24k) {
      basePrice = Number(data.price_gram_24k);
    }

  } catch (e) {
    console.error("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±", e);
  }

  // ØªØ·Ø¨ÙŠÙ‚ Ø³Ø¨Ø±ÙŠØ¯
  buyPrice  = basePrice * (1 + (spreadBuyPercent / 100));
  sellPrice = basePrice * (1 - (spreadSellPercent / 100));

  document.getElementById("goldPriceText").innerHTML =
    `Ø³Ø¹Ø± Ø§Ù„ØºØ±Ø§Ù… (24K) Live: <b>${basePrice.toFixed(2)}</b> Ù†Ù‚Ø·Ø©`;

  document.getElementById("goldPricesSmall").innerHTML =
    `Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: <b>${buyPrice.toFixed(2)}</b> â€” Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹: <b>${sellPrice.toFixed(2)}</b>`;

  document.getElementById("buyHint").innerText =
    `ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹: ÙƒÙ„ ${buyPrice.toFixed(2)} Ù†Ù‚Ø·Ø© = 1 Øº (Ø´Ø±Ø§Ø¡)`;

  document.getElementById("sellHint").innerText =
    `ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹: ÙƒÙ„ 1 Øº = ${sellPrice.toFixed(2)} Ù†Ù‚Ø·Ø© (Ø¨ÙŠØ¹)`;

  if (!tradingEnabled) {
    document.getElementById("buyBtn").disabled = true;
    document.getElementById("sellBtn").disabled = true;
    document.getElementById("buyHint").innerText = "â›” Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©";
    document.getElementById("sellHint").innerText = "â›” Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©";
  }
}

/* =====================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© + Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ÙØ¸Ø© Ø°Ù‡Ø¨ Ø¥Ø°Ø§ Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
===================== */
async function loadBalances() {
  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  let { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  if (!gold) {
    await supabase.from("gold_wallets").insert({ user_id: user.id, grams: 0 });
    gold = { grams: 0 };
  }

  document.getElementById("balances").innerHTML = `
    ğŸ’° Ø§Ù„Ù†Ù‚Ø§Ø·: <b>${Number(wallet?.points || 0).toFixed(2)}</b><br>
    ğŸª™ Ø§Ù„Ø°Ù‡Ø¨: <b>${Number(gold.grams || 0).toFixed(4)} Øº</b>
  `;
}

/* =====================
   Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© + PnL Ù„Ø­Ø¸ÙŠ
   (Average Cost Basis)
===================== */
async function loadPnL() {
  const pnlBox = document.getElementById("pnlBox");

  // Ø±ØµÙŠØ¯ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const { data: gw } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  const holding = Number(gw?.grams || 0);
  if (holding <= 0) {
    pnlBox.innerHTML = `ğŸ“‰ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©: <b>0</b> (Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø°Ù‡Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹)`;
    return;
  }

  // Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const { data: trades } = await supabase
    .from("gold_trades")
    .select("type, grams, price, points, created_at")
    .eq("user_id", user.id)
    .order("created_at", { ascending: true });

  if (!trades || trades.length === 0) {
    pnlBox.innerHTML = `ğŸ“‰ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©: <b>0</b>`;
    return;
  }

  // Ø­Ø³Ø§Ø¨ cost basis Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…ØªÙˆØ³Ø· Ù…ØªØ­Ø±Ùƒ
  let grams = 0;
  let cost = 0; // Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·
  let totalBuy = 0;
  let totalSell = 0;

  for (const t of trades) {
    const g = Number(t.grams);
    const p = Number(t.points);

    if (t.type === "buy") {
      grams += g;
      cost  += p;
      totalBuy += g;
    } else {
      // sell: Ù†Ù‚Ù„Ù„ cost Ø¨Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
      if (grams > 0) {
        const ratio = Math.min(1, g / grams);
        cost  -= cost * ratio;
        grams -= g;
        totalSell += g;
      }
    }
  }

  // cost basis Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
  const avgCost = grams > 0 ? (cost / grams) : 0;

  const currentValue = holding * sellPrice; // ØªÙ‚ÙŠÙŠÙ… Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
  const currentCost  = holding * avgCost;
  const pnl = currentValue - currentCost;

  const pnlSign = pnl >= 0 ? "ğŸ“ˆ" : "ğŸ“‰";
  const pnlColor = pnl >= 0 ? "color:#5cff8b" : "color:#ff5c5c";

  pnlBox.innerHTML = `
    ${pnlSign} Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠ:
    <b style="${pnlColor}">${pnl.toFixed(2)}</b> Ù†Ù‚Ø·Ø©<br>
    <span style="opacity:.8">
      Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹): <b>${avgCost.toFixed(2)}</b> Ù†Ù‚Ø·Ø©/Øº<br>
      Ø§Ø´ØªØ±ÙŠØª: <b>${totalBuy.toFixed(4)}</b> Øº â€” Ø¨Ø¹Øª: <b>${totalSell.toFixed(4)}</b> Øº
    </span>
  `;
}

/* =====================
   Ø´Ø±Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨
===================== */
document.getElementById("buyBtn").onclick = async () => {
  if (!tradingEnabled) return alert("â›” Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹");

  const points = Number(document.getElementById("buyPoints").value);
  if (!points || points <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­Ø©");

  const gramsToBuy = points / buyPrice;

  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  const currentPoints = Number(wallet?.points || 0);
  if (currentPoints < points) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  const { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  const currentGrams = Number(gold?.grams || 0);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
  await supabase
    .from("wallets")
    .update({ points: currentPoints - points })
    .eq("user_id", user.id);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ù‡Ø¨
  await supabase
    .from("gold_wallets")
    .update({ grams: currentGrams + gramsToBuy })
    .eq("user_id", user.id);

  // Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  await supabase
    .from("gold_trades")
    .insert({
      user_id: user.id,
      type: "buy",
      grams: gramsToBuy,
      price: buyPrice,
      points: points
    });

  alert("âœ… ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨");
  document.getElementById("buyPoints").value = "";
  await loadBalances();
  await loadHistory();
  await loadPnL();
};

/* =====================
   Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨
===================== */
document.getElementById("sellBtn").onclick = async () => {
  if (!tradingEnabled) return alert("â›” Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹");

  const gramsToSell = Number(document.getElementById("sellGrams").value);
  if (!gramsToSell || gramsToSell <= 0) return alert("Ø£Ø¯Ø®Ù„ ØºØ±Ø§Ù…Ø§Øª ØµØ­ÙŠØ­Ø©");

  const pointsBack = gramsToSell * sellPrice;

  const { data: gold } = await supabase
    .from("gold_wallets")
    .select("grams")
    .eq("user_id", user.id)
    .single();

  const currentGrams = Number(gold?.grams || 0);
  if (currentGrams < gramsToSell) return alert("Ø±ØµÙŠØ¯ Ø§Ù„Ø°Ù‡Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  const { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  const currentPoints = Number(wallet?.points || 0);

  // Ø®ØµÙ… Ø°Ù‡Ø¨
  await supabase
    .from("gold_wallets")
    .update({ grams: currentGrams - gramsToSell })
    .eq("user_id", user.id);

  // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·
  await supabase
    .from("wallets")
    .update({ points: currentPoints + pointsBack })
    .eq("user_id", user.id);

  // Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  await supabase
    .from("gold_trades")
    .insert({
      user_id: user.id,
      type: "sell",
      grams: gramsToSell,
      price: sellPrice,
      points: pointsBack
    });

  alert("âœ… ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨");
  document.getElementById("sellGrams").value = "";
  await loadBalances();
  await loadHistory();
  await loadPnL();
};

/* =====================
   Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
===================== */
async function loadHistory() {
  const box = document.getElementById("history");
  const { data } = await supabase
    .from("gold_trades")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(t => {
    const isBuy = t.type === "buy";
    box.innerHTML += `
      <div class="small">
        ${isBuy ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : "ğŸ”´ Ø¨ÙŠØ¹"} â€”
        <b>${Number(t.grams).toFixed(4)}</b> Øº â€”
        Ø¨Ø³Ø¹Ø± <b>${Number(t.price).toFixed(2)}</b>
        <br>
        Ø§Ù„Ù†Ù‚Ø§Ø·: <b>${Number(t.points).toFixed(2)}</b>
        <br>
        <small>${new Date(t.created_at).toLocaleString()}</small>
        <hr>
      </div>
    `;
  });
}

/* =====================
   ØªØ´ØºÙŠÙ„ + ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ
===================== */
await loadGoldSettings();
await loadGoldPrice();
await loadBalances();
await loadHistory();
await loadPnL();

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
setInterval(async () => {
  await loadGoldSettings();
  await loadGoldPrice();
  await loadBalances();
  await loadPnL();
}, 10000);

</script>
</body>
</html>
