<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small" id="adminEmail">...</p>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="card">
    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>

    <input id="searchEmail" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <div style="height:10px"></div>

    <button id="loadUsers" class="btn btn-primary">
      ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    </button>

    <div style="height:10px"></div>
    <div id="usersList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† -->
  <div class="card">
    <h3>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
    <button class="btn btn-primary" onclick="location.href='add-ad.html'">
      â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†
    </button>
    <div style="height:10px"></div>
    <div id="adsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="depositsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div class="small">âš ï¸ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯ 35 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†</div>
    <div id="withdrawalsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>
</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =====================
   Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
===================== */
const ADMIN_EMAIL = "am.alsus1995@gmail.com";

const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";
if (user.email !== ADMIN_EMAIL) {
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
  location.href = "dashboard.html";
}

document.getElementById("adminEmail").innerText = user.email;

/* =====================
   Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
===================== */
async function loadUsers() {
  const box = document.getElementById("usersList");
  box.innerText = "ØªØ­Ù…ÙŠÙ„...";

  const emailSearch = document.getElementById("searchEmail").value.trim();

  let query = supabase
    .from("profiles")
    .select(`
      user_id,
      email,
      full_name,
      level,
      wallets(points)
    `);

  if (emailSearch) {
    query = query.ilike("email", `%${emailSearch}%`);
  }

  const { data, error } = await query;

  if (error) {
    box.innerText = "Ø®Ø·Ø£: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†";
    return;
  }

  box.innerHTML = "";
  data.forEach(u => {
    const div = document.createElement("div");
    div.innerHTML = `
      <b>${u.email}</b><br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${u.wallets?.points || 0}<br>
      Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${u.level}<br>
      <button class="btn btn-ghost">â• Ø¥Ø¶Ø§ÙØ© 10 Ù†Ù‚Ø§Ø·</button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {
      const current = u.wallets?.points || 0;
      await supabase
        .from("wallets")
        .update({ points: current + 10 })
        .eq("user_id", u.user_id);

      loadUsers();
    };

    box.appendChild(div);
  });
}

document.getElementById("loadUsers").onclick = loadUsers;
loadUsers();

/* =====================
   Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
===================== */
async function loadAds() {
  const box = document.getElementById("adsList");

  const { data } = await supabase
    .from("ads")
    .select("*")
    .order("id", { ascending: false });

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(ad => {
    const div = document.createElement("div");
    div.innerHTML = `
      <b>${ad.title}</b><br>
      Ù…ÙƒØ§ÙØ£Ø©: ${ad.reward_points} Ù†Ù‚Ø§Ø·<br>
      Ø§Ù„Ø­Ø§Ù„Ø©: ${ad.is_active ? "Ù…ÙØ¹Ù„" : "Ù…ÙˆÙ‚Ù"}<br>
      <button class="btn btn-ghost">
        ${ad.is_active ? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"}
      </button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {
      await supabase
        .from("ads")
        .update({ is_active: !ad.is_active })
        .eq("id", ad.id);

      loadAds();
    };

    box.appendChild(div);
  });
}
loadAds();

/* =====================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†
===================== */
async function loadDeposits() {
  const box = document.getElementById("depositsList");

  const { data } = await supabase
    .from("deposits")
    .select("*")
    .eq("status", "pending");

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(d => {
    const div = document.createElement("div");
    div.innerHTML = `
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${d.user_id}<br>
      Ø§Ù„Ù…Ø¨Ù„Øº: ${d.amount}<br>
      <button class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {
      await supabase
        .from("deposits")
        .update({ status: "approved" })
        .eq("id", d.id);

      loadDeposits();
    };

    box.appendChild(div);
  });
}
loadDeposits();

/* =====================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨
===================== */
async function loadWithdrawals() {
  const box = document.getElementById("withdrawalsList");

  const { data } = await supabase
    .from("withdrawals")
    .select("*")
    .eq("status", "pending");

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(w => {
    const div = document.createElement("div");
    div.innerHTML = `
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${w.user_id}<br>
      Ø§Ù„Ù…Ø¨Ù„Øº: ${w.amount}<br>
      <button class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
      <button class="btn btn-danger">Ø±ÙØ¶</button>
      <hr>
    `;

    const [approveBtn, rejectBtn] = div.querySelectorAll("button");

    approveBtn.onclick = async () => {
      await supabase
        .from("withdrawals")
        .update({ status: "approved" })
        .eq("id", w.id);
      loadWithdrawals();
    };

    rejectBtn.onclick = async () => {
      await supabase
        .from("withdrawals")
        .update({ status: "rejected" })
        .eq("id", w.id);
      loadWithdrawals();
    };

    box.appendChild(div);
  });
}
loadWithdrawals();

</script>

</body>
</html>
