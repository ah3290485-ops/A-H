<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â€“ Ø§Ù„Ø´Ø­Ù† â€“ Ø§Ù„Ø³Ø­Ø¨</p>
      <p class="small" id="adminEmail"></p>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="card">
    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>

    <input id="searchEmail" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <div style="height:10px"></div>
    <button id="loadUsers" class="btn btn-primary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>

    <div id="usersList" class="small" style="margin-top:10px">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="depositsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <p class="small">âš ï¸ Ø§Ù„Ø³Ø­Ø¨ Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¹Ø¯ 35 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†</p>
    <div id="withdrawalsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>
</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =====================
   Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
===================== */
const ADMIN_EMAIL = "am.alsus1995@gmail.com";

const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";
if (user.email !== ADMIN_EMAIL) {
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
  location.href = "dashboard.html";
}

document.getElementById("adminEmail").innerText =
  "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙƒØ£Ø¯Ù…Ù†: " + user.email;

/* =====================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
===================== */
async function loadUsers() {
  const box = document.getElementById("usersList");
  box.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  const emailSearch = document.getElementById("searchEmail").value.trim();

  const { data, error } = await supabase
    .from("profiles")
    .select(`
      user_id,
      full_name,
      level,
      wallets ( points ),
      auth_users:auth.users ( email )
    `);

  if (error) {
    box.innerText = "Ø®Ø·Ø£: " + error.message;
    return;
  }

  let users = data;

  if (emailSearch) {
    users = users.filter(u =>
      u.auth_users?.email?.includes(emailSearch)
    );
  }

  if (users.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†";
    return;
  }

  box.innerHTML = "";

  users.forEach(u => {
    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #333";
    div.style.padding = "8px 0";

    div.innerHTML = `
      ğŸ“§ ${u.auth_users?.email || "-"}<br>
      ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${u.full_name || "-"}<br>
      â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${u.level || "Ø¹Ø§Ø¯ÙŠ"}<br>
      ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: ${u.wallets?.points || 0} Ù†Ù‚Ø·Ø©
    `;

    box.appendChild(div);
  });
}

document.getElementById("loadUsers").onclick = loadUsers;

/* =====================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†
===================== */
async function loadDeposits() {
  const box = document.getElementById("depositsList");

  const { data } = await supabase
    .from("deposits")
    .select("*")
    .eq("status", "pending");

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  box.innerHTML = "";

  data.forEach(d => {
    const div = document.createElement("div");
    div.innerHTML = `
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${d.user_id}<br>
      Ø§Ù„Ù…Ø¨Ù„Øº: ${d.amount_usd}$<br>
      TXID: ${d.txid || "-"}<br>
      <button class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {
      const { data: wallet } = await supabase
        .from("wallets")
        .select("points")
        .eq("user_id", d.user_id)
        .single();

      await supabase
        .from("wallets")
        .update({ points: (wallet?.points || 0) + d.amount_usd })
        .eq("user_id", d.user_id);

      await supabase
        .from("deposits")
        .update({ status: "approved" })
        .eq("id", d.id);

      alert("âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†");
      loadDeposits();
    };

    box.appendChild(div);
  });
}

/* =====================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨
===================== */
async function loadWithdrawals() {
  const box = document.getElementById("withdrawalsList");

  const { data } = await supabase
    .from("withdrawals")
    .select("*")
    .eq("status", "pending");

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  box.innerHTML = "";

  data.forEach(w => {
    const div = document.createElement("div");
    div.innerHTML = `
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${w.user_id}<br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${w.points}<br>
      Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${w.wallet_address}<br>
      <button class="btn btn-primary">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {
      const { data: wallet } = await supabase
        .from("wallets")
        .select("points")
        .eq("user_id", w.user_id)
        .single();

      if (!wallet || wallet.points < w.points) {
        alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ");
        return;
      }

      await supabase
        .from("wallets")
        .update({ points: wallet.points - w.points })
        .eq("user_id", w.user_id);

      await supabase
        .from("withdrawals")
        .update({ status: "paid" })
        .eq("id", w.id);

      alert("âœ… ØªÙ… Ø§Ù„Ø³Ø­Ø¨");
      loadWithdrawals();
    };

    box.appendChild(div);
  });
}

loadUsers();
loadDeposits();
loadWithdrawals();
</script>

</body>
</html>
