<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€“ Ø§Ù„Ø´Ø­Ù† â€“ Ø§Ù„Ø³Ø­Ø¨</p>
    </div>
  </div>

  <!-- Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
  <div class="card">
    <h3>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
    <div id="adsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="depositsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div id="withdrawalsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">Ø±Ø¬ÙˆØ¹</a>
</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =========================
   Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
========================= */
const ADMIN_EMAILS = ["am.alsus1995@gmail.com"];

const { data: { user } } = await supabase.auth.getUser();
if (!user) window.location.href = "login.html";
if (!ADMIN_EMAILS.includes(user.email)) {
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
  window.location.href = "dashboard.html";
}

/* =========================
   Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
========================= */
async function loadAds() {
  const box = document.getElementById("adsList");
  const { data } = await supabase
    .from("ads")
    .select("*")
    .order("id", { ascending: false });

  if (!data || data.length === 0) {
    box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(ad => {
    const div = document.createElement("div");
    div.innerHTML = `
      <b>${ad.title}</b><br>
      Ù†Ù‚Ø§Ø·: ${ad.reward_points}<br>
      Ø§Ù„Ø­Ø§Ù„Ø©: ${ad.is_active ? "Ù…ÙØ¹Ù„" : "Ù…ÙˆÙ‚Ù"}<br>
      <button class="btn btn-ghost">
        ${ad.is_active ? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"}
      </button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {
      await supabase
        .from("ads")
        .update({ is_active: !ad.is_active })
        .eq("id", ad.id);
      loadAds();
    };

    box.appendChild(div);
  });
}

/* =========================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†
========================= */
async function loadDeposits() {
  const box = document.getElementById("depositsList");
  const { data } = await supabase
    .from("deposits")
    .select("*")
    .eq("status", "pending");

  if (!data || data.length === 0) {
    box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(d => {
    const div = document.createElement("div");
    div.innerHTML = `
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${d.user_id}<br>
      Ø§Ù„Ù…Ø¨Ù„Øº: ${d.amount_usd}$<br>
      TXID: ${d.txid || "-"}<br>
      <button class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {

      // Ø¬Ù„Ø¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ÙØ¸Ø©
      let { data: wallet } = await supabase
        .from("wallets")
        .select("points")
        .eq("user_id", d.user_id)
        .single();

      if (!wallet) {
        await supabase.from("wallets").insert({
          user_id: d.user_id,
          points: 0
        });
        wallet = { points: 0 };
      }

      const amount = Number(d.amount_usd);
      if (isNaN(amount) || amount <= 0) {
        alert("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù† ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        return;
      }

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯
      await supabase
        .from("wallets")
        .update({ points: wallet.points + amount })
        .eq("user_id", d.user_id);

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
      await supabase
        .from("deposits")
        .update({ status: "approved" })
        .eq("id", d.id);

      alert("âœ… ØªÙ… Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯");
      loadDeposits();
    };

    box.appendChild(div);
  });
}

/* =========================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Ù…Ø¹ Ø´Ø±Ø· 35 ÙŠÙˆÙ…)
========================= */
async function loadWithdrawals() {
  const box = document.getElementById("withdrawalsList");
  const { data } = await supabase
    .from("withdrawals")
    .select("*")
    .eq("status", "pending");

  if (!data || data.length === 0) {
    box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  box.innerHTML = "";
  data.forEach(w => {
    const div = document.createElement("div");
    div.innerHTML = `
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${w.user_id}<br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${w.points}<br>
      Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${w.wallet_address}<br>
      <button class="btn btn-primary">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
      <hr>
    `;

    div.querySelector("button").onclick = async () => {

      // ğŸ”’ Ø´Ø±Ø· 35 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†
      const { data: firstDeposit } = await supabase
        .from("deposits")
        .select("created_at")
        .eq("user_id", w.user_id)
        .eq("status", "approved")
        .order("created_at", { ascending: true })
        .limit(1)
        .single();

      if (!firstDeposit) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø­Ù† Ù…Ø¹ØªÙ…Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        return;
      }

      const firstDate = new Date(firstDeposit.created_at);
      const now = new Date();
      const diffDays = Math.floor((now - firstDate) / (1000 * 60 * 60 * 24));

      if (diffDays < 35) {
        alert(`âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ 35 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†\nØ§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${35 - diffDays} ÙŠÙˆÙ…`);
        return;
      }

      // Ø¬Ù„Ø¨ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      let { data: wallet } = await supabase
        .from("wallets")
        .select("points")
        .eq("user_id", w.user_id)
        .single();

      if (!wallet) {
        alert("Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        return;
      }

      const withdrawPoints = Number(w.points);
      if (wallet.points < withdrawPoints) {
        alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ");
        return;
      }

      // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
      await supabase
        .from("wallets")
        .update({ points: wallet.points - withdrawPoints })
        .eq("user_id", w.user_id);

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨
      await supabase
        .from("withdrawals")
        .update({ status: "paid" })
        .eq("id", w.id);

      alert("âœ… ØªÙ… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯");
      loadWithdrawals();
    };

    box.appendChild(div);
  });
}

loadAds();
loadDeposits();
loadWithdrawals();
</script>

</body>
</html>
