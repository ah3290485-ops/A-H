<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <link rel="stylesheet" href="assets/styles.css">
  <style>
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{opacity:.75}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill-ok{background:#1f6f3a}
    .pill-bad{background:#7a1f1f}
    .mini{font-size:12px;opacity:.8}
    input,select{width:100%}
    .rowbtn{display:flex;gap:8px;flex-wrap:wrap}
    .rowbtn .btn{flex:1;min-width:120px}
    hr{opacity:.15}
  </style>
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â€“ Ø§Ù„Ø±ØµÙŠØ¯ â€“ Ø§Ù„Ø´Ø­Ù† â€“ Ø§Ù„Ø³Ø­Ø¨ â€“ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>
      <p id="me" class="mini muted"></p>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="card">
    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>

    <div class="grid2">
      <div>
        <label class="small">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input id="searchEmail" type="text" placeholder="Ù…Ø«Ø§Ù„: user@gmail.com">
      </div>
      <div>
        <label class="small">Ø¹Ø±Ø¶</label>
        <select id="filterStatus">
          <option value="all">Ø§Ù„ÙƒÙ„</option>
          <option value="active">Ù†Ø´Ø·</option>
          <option value="banned">Ù…Ø­Ø¸ÙˆØ±</option>
        </select>
      </div>
    </div>

    <div style="height:10px"></div>
    <button id="reloadUsers" class="btn btn-ghost">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>

    <div style="height:12px"></div>
    <div id="usersList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="depositsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div class="small muted">âš ï¸ Ø§Ù„Ø³Ø­Ø¨ Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¹Ø¯ 35 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†</div>
    <div style="height:8px"></div>
    <div id="withdrawalsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
  <div class="card">
    <h3>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>

    <div class="grid2">
      <div>
        <label class="small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
        <input id="adTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙŠÙˆÙ…">
      </div>
      <div>
        <label class="small">Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨</label>
        <input id="adUrl" type="text" placeholder="https://youtube.com/...">
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="grid2">
      <div>
        <label class="small">Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</label>
        <input id="adReward" type="number" placeholder="Ù…Ø«Ø§Ù„: 3">
      </div>
      <div>
        <label class="small">Ù…ÙØ¹Ù„ØŸ</label>
        <select id="adActive">
          <option value="true">Ù…ÙØ¹Ù„</option>
          <option value="false">Ù…ÙˆÙ‚Ù</option>
        </select>
      </div>
    </div>

    <div style="height:10px"></div>
    <button id="createAd" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</button>

    <div style="height:12px"></div>
    <div id="adsList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>
</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =========================
   Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
========================= */
const ADMIN_EMAILS = ["am.alsus1995@gmail.com"];

const { data: { user } } = await supabase.auth.getUser();
if (!user) window.location.href = "login.html";
if (!ADMIN_EMAILS.includes(user.email)) {
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
  window.location.href = "dashboard.html";
}
document.getElementById("me").innerText = "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙƒØ£Ø¯Ù…Ù†: " + user.email;

/* =========================
   Helpers
========================= */
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function daysBetween(a,b){ return (b-a)/(1000*60*60*24); }

/* =========================
   USERS (profiles + wallets)
   Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ Ø¬Ø¯ÙˆÙ„ profiles ÙÙŠÙ‡:
   user_id (uuid) PK, email (text), status (text) default 'active', created_at
========================= */
async function loadUsers() {
  const box = document.getElementById("usersList");
  box.innerHTML = "ØªØ­Ù…ÙŠÙ„...";

  const q = document.getElementById("searchEmail").value.trim().toLowerCase();
  const fs = document.getElementById("filterStatus").value;

  let req = supabase
    .from("profiles")
    .select("user_id,email,status,created_at");

  if (fs !== "all") req = req.eq("status", fs);
  if (q) req = req.ilike("email", `%${q}%`);

  const { data: profiles, error } = await req.order("created_at", { ascending: false }).limit(50);
  if (error) {
    box.innerHTML = "Ø®Ø·Ø£: " + esc(error.message);
    return;
  }

  if (!profiles || profiles.length === 0) {
    box.innerHTML = "<div class='small muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</div>";
    return;
  }

  box.innerHTML = "";
  for (const p of profiles) {
    // wallet
    let { data: wallet } = await supabase
      .from("wallets")
      .select("points, first_deposit_at")
      .eq("user_id", p.user_id)
      .single();

    if (!wallet) wallet = { points: 0, first_deposit_at: null };

    const statusPill = p.status === "active"
      ? "<span class='pill pill-ok'>Ù†Ø´Ø·</span>"
      : "<span class='pill pill-bad'>Ù…Ø­Ø¸ÙˆØ±</span>";

    const canWithdraw = wallet.first_deposit_at
      ? (daysBetween(new Date(wallet.first_deposit_at), new Date()) >= 35)
      : false;

    const card = document.createElement("div");
    card.style.marginBottom = "12px";
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div style="font-weight:800">${esc(p.email || "-")}</div>
          <div class="mini muted">UID: ${esc(p.user_id)}</div>
          <div class="mini muted">Ø§Ù„Ø±ØµÙŠØ¯: <b>${esc(wallet.points)}</b> Ù†Ù‚Ø·Ø©</div>
          <div class="mini muted">Ø§Ù„Ø³Ø­Ø¨: ${canWithdraw ? "âœ… Ù…Ø³Ù…ÙˆØ­" : "â³ Ø¨Ø¹Ø¯ 35 ÙŠÙˆÙ…"}</div>
        </div>
        <div>${statusPill}</div>
      </div>

      <div style="height:10px"></div>

      <div class="grid2">
        <div>
          <label class="small">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ (+/-)</label>
          <input data-amt type="number" placeholder="Ù…Ø«Ø§Ù„: 50 Ø£Ùˆ -10">
        </div>
        <div>
          <label class="small">Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input data-note type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙƒØ§ÙØ£Ø© / ØªØµØ­ÙŠØ­">
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="rowbtn">
        <button data-add class="btn btn-primary">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±ØµÙŠØ¯</button>
        <button data-toggle class="btn btn-ghost">${p.status === "active" ? "ğŸš« Ø­Ø¸Ø±" : "âœ… ØªÙØ¹ÙŠÙ„"}</button>
        <button data-reset class="btn btn-danger" disabled title="ÙŠØªØ·Ù„Ø¨ Edge Function">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</button>
        <button data-email class="btn btn-danger" disabled title="ÙŠØªØ·Ù„Ø¨ Edge Function">âœ‰ï¸ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</button>
      </div>
      <hr>
    `;

    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
    card.querySelector("[data-add]").onclick = async () => {
      const delta = Number(card.querySelector("[data-amt]").value);
      const note = card.querySelector("[data-note]").value.trim();
      if (!delta || isNaN(delta)) { alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©"); return; }

      // Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯
      let { data: w } = await supabase
        .from("wallets")
        .select("points")
        .eq("user_id", p.user_id)
        .single();

      if (!w) {
        await supabase.from("wallets").insert({ user_id: p.user_id, points: 0 });
        w = { points: 0 };
      }

      const newPoints = Number(w.points) + delta;
      if (newPoints < 0) { alert("Ù…Ø§ ÙÙŠÙƒ ØªØ®Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨"); return; }

      await supabase.from("wallets")
        .update({ points: newPoints })
        .eq("user_id", p.user_id);

      // Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø¬Ø¯ÙˆÙ„ ledger
      // await supabase.from("ledger").insert({ user_id: p.user_id, type:"admin_adjust", amount: delta, note });

      alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ âœ…");
      loadUsers();
    };

    // Ø­Ø¸Ø±/ØªÙØ¹ÙŠÙ„
    card.querySelector("[data-toggle]").onclick = async () => {
      const next = p.status === "active" ? "banned" : "active";
      await supabase.from("profiles")
        .update({ status: next })
        .eq("user_id", p.user_id);

      alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© âœ…");
      loadUsers();
    };

    box.appendChild(card);
  }
}

document.getElementById("reloadUsers").onclick = loadUsers;
document.getElementById("searchEmail").addEventListener("input", () => {
  clearTimeout(window._t); window._t = setTimeout(loadUsers, 400);
});
document.getElementById("filterStatus").onchange = loadUsers;

/* =========================
   Deposits approve/reject
========================= */
async function loadDeposits() {
  const box = document.getElementById("depositsList");
  box.innerHTML = "ØªØ­Ù…ÙŠÙ„...";

  const { data, error } = await supabase
    .from("deposits")
    .select("*")
    .eq("status", "pending")
    .order("id", { ascending: false });

  if (error) { box.innerHTML = "Ø®Ø·Ø£: " + esc(error.message); return; }
  if (!data || data.length === 0) { box.innerHTML = "<div class='small muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>"; return; }

  box.innerHTML = "";
  data.forEach(d => {
    const div = document.createElement("div");
    div.innerHTML = `
      <b>Ø·Ù„Ø¨ Ø´Ø­Ù†</b><br>
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span class="mini">${esc(d.user_id)}</span><br>
      Ø§Ù„Ù…Ø¨Ù„Øº: <b>${esc(d.amount_usd)}</b> USDT<br>
      TXID: <span class="mini">${esc(d.txid || "-")}</span><br>
      <div style="height:8px"></div>
      <div class="rowbtn">
        <button class="btn btn-primary">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn btn-danger">âŒ Ø±ÙØ¶</button>
      </div>
      <hr>
    `;

    const [btnOk, btnNo] = div.querySelectorAll("button");

    btnOk.onclick = async () => {
      // wallet
      let { data: w } = await supabase.from("wallets").select("points, first_deposit_at").eq("user_id", d.user_id).single();
      if (!w) {
        await supabase.from("wallets").insert({ user_id: d.user_id, points: 0, first_deposit_at: new Date().toISOString() });
        w = { points: 0, first_deposit_at: new Date().toISOString() };
      }

      const add = Number(d.amount_usd || 0);
      const updates = { points: Number(w.points) + add };
      if (!w.first_deposit_at) updates.first_deposit_at = new Date().toISOString();

      await supabase.from("wallets").update(updates).eq("user_id", d.user_id);
      await supabase.from("deposits").update({ status: "approved" }).eq("id", d.id);

      alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† âœ…");
      loadDeposits(); loadUsers();
    };

    btnNo.onclick = async () => {
      await supabase.from("deposits").update({ status: "rejected" }).eq("id", d.id);
      alert("ØªÙ… Ø§Ù„Ø±ÙØ¶ âœ…");
      loadDeposits();
    };

    box.appendChild(div);
  });
}

/* =========================
   Withdrawals approve/reject + deduct
========================= */
async function loadWithdrawals() {
  const box = document.getElementById("withdrawalsList");
  box.innerHTML = "ØªØ­Ù…ÙŠÙ„...";

  const { data, error } = await supabase
    .from("withdrawals")
    .select("*")
    .eq("status", "pending")
    .order("id", { ascending: false });

  if (error) { box.innerHTML = "Ø®Ø·Ø£: " + esc(error.message); return; }
  if (!data || data.length === 0) { box.innerHTML = "<div class='small muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>"; return; }

  box.innerHTML = "";
  for (const w of data) {
    let { data: wallet } = await supabase
      .from("wallets")
      .select("points, first_deposit_at")
      .eq("user_id", w.user_id)
      .single();

    if (!wallet) wallet = { points: 0, first_deposit_at: null };

    const allow = wallet.first_deposit_at
      ? (daysBetween(new Date(wallet.first_deposit_at), new Date()) >= 35)
      : false;

    const div = document.createElement("div");
    div.innerHTML = `
      <b>Ø·Ù„Ø¨ Ø³Ø­Ø¨</b><br>
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span class="mini">${esc(w.user_id)}</span><br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: <b>${esc(w.points)}</b><br>
      Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span class="mini">${esc(w.wallet_address || "-")}</span><br>
      <div class="mini muted">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${esc(wallet.points)} Ù†Ù‚Ø·Ø©</div>
      <div class="mini">${allow ? "âœ… Ø´Ø±Ø· 35 ÙŠÙˆÙ… Ù…Ø­Ù‚Ù‚" : "â³ Ù„Ù… ÙŠÙƒÙ…Ù„ 35 ÙŠÙˆÙ…"}</div>
      <div style="height:8px"></div>
      <div class="rowbtn">
        <button class="btn btn-primary" ${!allow ? "disabled" : ""}>âœ… Ù‚Ø¨ÙˆÙ„ (ØªÙ… Ø§Ù„Ø¯ÙØ¹)</button>
        <button class="btn btn-danger">âŒ Ø±ÙØ¶</button>
      </div>
      <hr>
    `;

    const [btnOk, btnNo] = div.querySelectorAll("button");

    btnOk.onclick = async () => {
      const pts = Number(w.points || 0);
      if (pts <= 0) { alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }

      // refresh wallet points
      const { data: w2 } = await supabase.from("wallets").select("points").eq("user_id", w.user_id).single();
      const current = Number(w2?.points || 0);
      if (current < pts) { alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ"); return; }

      await supabase.from("wallets").update({ points: current - pts }).eq("user_id", w.user_id);
      await supabase.from("withdrawals").update({ status: "paid" }).eq("id", w.id);

      alert("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ âœ…");
      loadWithdrawals(); loadUsers();
    };

    btnNo.onclick = async () => {
      await supabase.from("withdrawals").update({ status: "rejected" }).eq("id", w.id);
      alert("ØªÙ… Ø§Ù„Ø±ÙØ¶ âœ…");
      loadWithdrawals();
    };

    box.appendChild(div);
  }
}

/* =========================
   Ads create + toggle
========================= */
async function loadAds() {
  const box = document.getElementById("adsList");
  box.innerHTML = "ØªØ­Ù…ÙŠÙ„...";

  const { data, error } = await supabase.from("ads").select("*").order("id", { ascending: false });
  if (error) { box.innerHTML = "Ø®Ø·Ø£: " + esc(error.message); return; }
  if (!data || data.length === 0) { box.innerHTML = "<div class='small muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>"; return; }

  box.innerHTML = "";
  data.forEach(ad => {
    const div = document.createElement("div");
    div.innerHTML = `
      <b>${esc(ad.title)}</b><br>
      <span class="mini muted">${esc(ad.youtube_url || "")}</span><br>
      Ù†Ù‚Ø§Ø·: <b>${esc(ad.reward_points)}</b><br>
      Ø§Ù„Ø­Ø§Ù„Ø©: <b>${ad.is_active ? "Ù…ÙØ¹Ù„" : "Ù…ÙˆÙ‚Ù"}</b><br>
      <div style="height:8px"></div>
      <div class="rowbtn">
        <button class="btn btn-ghost">${ad.is_active ? "â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù" : "â–¶ï¸ ØªÙØ¹ÙŠÙ„"}</button>
      </div>
      <hr>
    `;
    div.querySelector("button").onclick = async () => {
      await supabase.from("ads").update({ is_active: !ad.is_active }).eq("id", ad.id);
      loadAds();
    };
    box.appendChild(div);
  });
}

document.getElementById("createAd").onclick = async () => {
  const title = document.getElementById("adTitle").value.trim();
  const url = document.getElementById("adUrl").value.trim();
  const reward = Number(document.getElementById("adReward").value);
  const active = document.getElementById("adActive").value === "true";

  if (!title || !url || !reward || reward <= 0) {
    alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙƒØ§Ù…Ù„Ø©");
    return;
  }

  await supabase.from("ads").insert({
    title,
    youtube_url: url,
    reward_points: reward,
    is_active: active
  });

  document.getElementById("adTitle").value = "";
  document.getElementById("adUrl").value = "";
  document.getElementById("adReward").value = "";

  alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…");
  loadAds();
};

/* =========================
   Init
========================= */
await loadUsers();
await loadDeposits();
await loadWithdrawals();
await loadAds();
</script>

</body>
</html>
