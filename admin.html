<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ููุญุฉ ุงูุฅุฏุงุฑุฉ</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>๐๏ธ ููุญุฉ ุงูุฅุฏุงุฑุฉ</h1>
      <p class="small" id="adminEmail">...</p>
    </div>
  </div>

  <!-- ุงููุณุชุฎุฏููู -->
  <div class="card">
    <h3>๐ฅ ุงููุณุชุฎุฏููู</h3>

    <input id="searchEmail" type="text" placeholder="ุจุญุซ ุจุงูุฅูููู">
    <div style="height:10px"></div>

    <button id="loadUsers" class="btn btn-primary">๐ ุชุญุฏูุซ ุงููุณุชุฎุฏููู</button>

    <div style="height:10px"></div>
    <div id="usersList">ุชุญููู...</div>
  </div>

  <!-- ุชุนุฏูู ุฑุตูุฏ ูุณุชุฎุฏู -->
  <div class="card">
    <h3>โ ุชุนุฏูู ุฑุตูุฏ ุงููุณุชุฎุฏู</h3>

    <input id="targetUserId" type="text" placeholder="User ID">
    <div style="height:8px"></div>

    <input id="pointsAmount" type="number" placeholder="ุนุฏุฏ ุงูููุงุท">
    <div style="height:10px"></div>

    <button id="addPointsBtn" class="btn btn-primary">ุฅุถุงูุฉ ููุงุท</button>
    <div style="height:6px"></div>
    <button id="removePointsBtn" class="btn btn-danger">ุฎุตู ููุงุท</button>
  </div>

  <!-- ุงูุฅุนูุงูุงุช -->
  <div class="card">
    <h3>๐บ ุงูุฅุนูุงูุงุช</h3>
    <button class="btn btn-primary" onclick="location.href='add-ad.html'">
      โ ุฅุถุงูุฉ ุฅุนูุงู
    </button>
    <div style="height:10px"></div>
    <div id="adsList">โ</div>
  </div>

  <!-- ุทูุจุงุช ุงูุดุญู -->
  <div class="card">
    <h3>๐ณ ุทูุจุงุช ุงูุดุญู</h3>
    <div id="depositsList">โ</div>
  </div>

  <!-- ุทูุจุงุช ุงูุณุญุจ -->
  <div class="card">
    <h3>๐ธ ุทูุจุงุช ุงูุณุญุจ</h3>
    <div class="small">โ๏ธ ุงูุณุญุจ ุจุนุฏ 35 ููู ูู ุฃูู ุดุญู</div>
    <div id="withdrawalsList">โ</div>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">โฌ๏ธ ุฑุฌูุน</a>

</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* ===== ุญูุงูุฉ ุงูุฃุฏูู ===== */
const ADMIN_EMAIL = "am.alsus1995@gmail.com";

const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";
if (user.email !== ADMIN_EMAIL) {
  alert("ุบูุฑ ูุตุฑุญ ูู");
  location.href = "dashboard.html";
}

document.getElementById("adminEmail").innerText = user.email;

/* ===== ุชุญููู ุงููุณุชุฎุฏููู ===== */
async function loadUsers() {
  const box = document.getElementById("usersList");
  box.innerText = "ุชุญููู...";

  const emailSearch = document.getElementById("searchEmail").value.trim();

  let query = supabase
    .from("profiles")
    .select(`
      user_id,
      email,
      full_name,
      level,
      wallets(points)
    `);

  if (emailSearch) {
    query = query.ilike("email", `%${emailSearch}%`);
  }

  const { data, error } = await query;

  if (error) {
    box.innerText = "ุฎุทุฃ: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    box.innerText = "ูุง ููุฌุฏ ูุณุชุฎุฏููู";
    return;
  }

  box.innerHTML = "";
  data.forEach(u => {
    box.innerHTML += `
      <div class="small">
        ๐ง ${u.email}<br>
        ๐ ${u.user_id}<br>
        ๐ฐ ุงูุฑุตูุฏ: ${u.wallets?.points || 0} ููุทุฉ
        <hr>
      </div>
    `;
  });
}

document.getElementById("loadUsers").onclick = loadUsers;
loadUsers();

/* ===== ุฅุถุงูุฉ / ุฎุตู ููุงุท ===== */
document.getElementById("addPointsBtn").onclick = () => updatePoints(true);
document.getElementById("removePointsBtn").onclick = () => updatePoints(false);

async function updatePoints(isAdd) {
  const userId = document.getElementById("targetUserId").value.trim();
  const amount = Number(document.getElementById("pointsAmount").value);

  if (!userId || !amount || amount <= 0) {
    alert("โ ุฃุฏุฎู User ID ูุนุฏุฏ ููุงุท ุตุญูุญ");
    return;
  }

  let { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", userId)
    .single();

  if (!wallet) {
    alert("โ ูุญูุธุฉ ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏุฉ");
    return;
  }

  const newPoints = isAdd
    ? wallet.points + amount
    : wallet.points - amount;

  if (newPoints < 0) {
    alert("โ ูุง ูููู ุฃู ูุตุจุญ ุงูุฑุตูุฏ ุณุงูุจ");
    return;
  }

  await supabase
    .from("wallets")
    .update({ points: newPoints })
    .eq("user_id", userId);

  /* ===== ุชุณุฌูู ุงููุนุงููุฉ (ุงูุฌุฏูุฏ) ===== */
  await supabase.from("transactions").insert({
    user_id: userId,
    type: isAdd ? "admin_add" : "admin_remove",
    amount: amount,
    description: isAdd
      ? "ุฅุถุงูุฉ ููุงุท ูู ุงูุฅุฏุงุฑุฉ"
      : "ุฎุตู ููุงุท ูู ุงูุฅุฏุงุฑุฉ"
  });

  alert("โ ุชู ุชุญุฏูุซ ุงูุฑุตูุฏ");
  loadUsers();
}
</script>

</body>
</html>
