<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small" id="adminEmail">...</p>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="card">
    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>

    <input id="searchEmail" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <div style="height:10px"></div>

    <button id="loadUsers" class="btn btn-primary">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>

    <div style="height:10px"></div>
    <div id="usersList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… -->
  <div class="card">
    <h3>â• ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>

    <input id="targetUserId" type="text" placeholder="User ID">
    <div style="height:8px"></div>

    <input id="pointsAmount" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">
    <div style="height:10px"></div>

    <button id="addPointsBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·</button>
    <div style="height:6px"></div>
    <button id="removePointsBtn" class="btn btn-danger">Ø®ØµÙ… Ù†Ù‚Ø§Ø·</button>
  </div>

  <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø°Ù‡Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div class="card">
    <h3>ğŸª™ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø°Ù‡Ø¨ (Ù…Ø³ØªØ®Ø¯Ù…)</h3>

    <input id="goldUserId" type="text" placeholder="User ID">
    <div style="height:10px"></div>

    <button id="enableGoldBtn" class="btn btn-primary">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨</button>
    <div style="height:6px"></div>
    <button id="disableGoldBtn" class="btn btn-danger">âŒ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø°Ù‡Ø¨</button>
  </div>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨ (Ø¹Ø§Ù…) -->
  <div class="card">
    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨ (Ø¹Ø§Ù…)</h3>

    <label class="small">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„</label>
    <select id="tradingEnabled" style="width:100%;padding:12px;border-radius:12px;border:none;outline:none;background:#0f0f0f;color:#fff">
      <option value="true">âœ… Ø´ØºÙ‘Ø§Ù„</option>
      <option value="false">â›” Ù…ØªÙˆÙ‚Ù</option>
    </select>

    <div style="height:10px"></div>

    <label class="small">Ø³Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ (%)</label>
    <input id="spreadBuy" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 0.50">

    <div style="height:10px"></div>

    <label class="small">Ø³Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ (%)</label>
    <input id="spreadSell" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 0.50">

    <div style="height:12px"></div>

    <button id="saveGoldSettings" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>

    <div class="small" id="goldSettingsMsg" style="margin-top:10px;opacity:.8">â€”</div>
  </div>

  <!-- Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
  <div class="card">
    <h3>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
    <button class="btn btn-primary" onclick="location.href='add-ad.html'">
      â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†
    </button>
    <div style="height:10px"></div>
    <div id="adsList">â€”</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="depositsList">â€”</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div class="small">âš ï¸ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯ 35 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†</div>
    <div id="withdrawalsList">â€”</div>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>

</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* ===== Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† ===== */
const ADMIN_EMAIL = "am.alsus1995@gmail.com";

const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";
if (user.email !== ADMIN_EMAIL) {
  alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
  location.href = "dashboard.html";
}

document.getElementById("adminEmail").innerText = user.email;

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ===== */
async function loadUsers() {
  const box = document.getElementById("usersList");
  box.innerText = "ØªØ­Ù…ÙŠÙ„...";

  const emailSearch = document.getElementById("searchEmail").value.trim();

  let query = supabase
    .from("profiles")
    .select(`
      user_id,
      email,
      full_name,
      level,
      wallets(points, gold_enabled)
    `);

  if (emailSearch) {
    query = query.ilike("email", `%${emailSearch}%`);
  }

  const { data, error } = await query;

  if (error) {
    box.innerText = "Ø®Ø·Ø£: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†";
    return;
  }

  box.innerHTML = "";
  data.forEach(u => {
    box.innerHTML += `
      <div class="small">
        ğŸ“§ ${u.email}<br>
        ğŸ†” ${u.user_id}<br>
        ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: ${u.wallets?.points || 0} Ù†Ù‚Ø·Ø©<br>
        ğŸª™ Ø§Ù„Ø°Ù‡Ø¨: ${u.wallets?.gold_enabled ? "Ù…ÙØ¹Ù„" : "Ù…Ù‚ÙÙ„"}
        <hr>
      </div>
    `;
  });
}

document.getElementById("loadUsers").onclick = loadUsers;
loadUsers();

/* ===== Ø¥Ø¶Ø§ÙØ© / Ø®ØµÙ… Ù†Ù‚Ø§Ø· ===== */
document.getElementById("addPointsBtn").onclick = () => updatePoints(true);
document.getElementById("removePointsBtn").onclick = () => updatePoints(false);

async function updatePoints(isAdd) {
  const userId = document.getElementById("targetUserId").value.trim();
  const amount = Number(document.getElementById("pointsAmount").value);

  if (!userId || !amount || amount <= 0) {
    alert("âŒ Ø£Ø¯Ø®Ù„ User ID ÙˆØ¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­");
    return;
  }

  let { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", userId)
    .single();

  if (!wallet) {
    alert("âŒ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
    return;
  }

  const newPoints = isAdd ? Number(wallet.points) + amount : Number(wallet.points) - amount;

  if (newPoints < 0) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØµØ¨Ø­ Ø§Ù„Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨");
    return;
  }

  await supabase
    .from("wallets")
    .update({ points: newPoints })
    .eq("user_id", userId);

  alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯");
  loadUsers();
}

/* ===== ØªÙØ¹ÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø°Ù‡Ø¨ Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
document.getElementById("enableGoldBtn").onclick = async () => {
  const userId = document.getElementById("goldUserId").value.trim();
  if (!userId) return alert("Ø£Ø¯Ø®Ù„ User ID");

  await supabase
    .from("wallets")
    .update({ gold_enabled: true })
    .eq("user_id", userId);

  alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨");
  loadUsers();
};

document.getElementById("disableGoldBtn").onclick = async () => {
  const userId = document.getElementById("goldUserId").value.trim();
  if (!userId) return alert("Ø£Ø¯Ø®Ù„ User ID");

  await supabase
    .from("wallets")
    .update({ gold_enabled: false })
    .eq("user_id", userId);

  alert("âŒ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø°Ù‡Ø¨");
  loadUsers();
};

/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
const msg = document.getElementById("goldSettingsMsg");

async function loadSettingsUI() {
  const { data, error } = await supabase
    .from("gold_settings")
    .select("*")
    .eq("id", 1)
    .single();

  if (error) {
    msg.innerText = "Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: " + error.message;
    return;
  }

  document.getElementById("tradingEnabled").value = String(data.trading_enabled);
  document.getElementById("spreadBuy").value = data.spread_buy_percent ?? 0;
  document.getElementById("spreadSell").value = data.spread_sell_percent ?? 0;

  msg.innerText = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
}

document.getElementById("saveGoldSettings").onclick = async () => {
  const trading_enabled = document.getElementById("tradingEnabled").value === "true";
  const spread_buy_percent = Number(document.getElementById("spreadBuy").value || 0);
  const spread_sell_percent = Number(document.getElementById("spreadSell").value || 0);

  const { error } = await supabase
    .from("gold_settings")
    .update({
      trading_enabled,
      spread_buy_percent,
      spread_sell_percent,
      updated_at: new Date().toISOString()
    })
    .eq("id", 1);

  if (error) {
    msg.innerText = "âŒ Ø®Ø·Ø£ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: " + error.message;
    return;
  }

  msg.innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
};

loadSettingsUI();
</script>

</body>
</html>
