<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small" id="adminEmail">...</p>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="card">
    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <input id="searchEmail" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <div style="height:10px"></div>
    <button id="loadUsers" class="btn btn-primary">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
    <div style="height:10px"></div>
    <div id="usersList">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ -->
  <div class="card">
    <h3>â• ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <input id="targetUserId" type="text" placeholder="User ID">
    <div style="height:8px"></div>
    <input id="pointsAmount" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·">
    <div style="height:10px"></div>
    <button id="addPointsBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·</button>
    <div style="height:6px"></div>
    <button id="removePointsBtn" class="btn btn-danger">Ø®ØµÙ… Ù†Ù‚Ø§Ø·</button>
  </div>

  <!-- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ -->
  <div class="card">
    <h3>ğŸª™ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø°Ù‡Ø¨</h3>
    <input id="goldUserId" type="text" placeholder="User ID">
    <div style="height:10px"></div>
    <button id="enableGoldBtn" class="btn btn-primary">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨</button>
    <div style="height:6px"></div>
    <button id="disableGoldBtn" class="btn btn-danger">âŒ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø°Ù‡Ø¨</button>
  </div>

  <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø´Ù…ÙˆØ¹ -->
  <div class="card">
    <h3>ğŸ•¯ï¸ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø´Ù…ÙˆØ¹ Ø§Ù„Ø°Ù‡Ø¨</h3>

    <input id="cOpen" type="number" step="0.01" placeholder="Open">
    <div style="height:6px"></div>

    <input id="cHigh" type="number" step="0.01" placeholder="High">
    <div style="height:6px"></div>

    <input id="cLow" type="number" step="0.01" placeholder="Low">
    <div style="height:6px"></div>

    <input id="cClose" type="number" step="0.01" placeholder="Close">
    <div style="height:10px"></div>

    <button id="addCandleBtn" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ø´Ù…Ø¹Ø©</button>
    <div style="height:8px"></div>
    <button id="pumpGoldBtn" class="btn btn-success">ğŸ“ˆ Ø±ÙØ¹ Ø§Ù„Ø³Ø¹Ø±</button>
    <div style="height:6px"></div>
    <button id="dumpGoldBtn" class="btn btn-danger">ğŸ“‰ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±</button>
  </div>

  <a href="dashboard.html" class="btn btn-ghost">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>
</div>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* ===== Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† ===== */
const ADMIN_EMAIL = "am.alsus1995@gmail.com";
const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";
if (user.email !== ADMIN_EMAIL) location.href = "dashboard.html";
document.getElementById("adminEmail").innerText = user.email;

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ===== */
async function loadUsers() {
  const box = document.getElementById("usersList");
  box.innerText = "ØªØ­Ù…ÙŠÙ„...";
  const emailSearch = document.getElementById("searchEmail").value.trim();

  let query = supabase.from("profiles").select(`
    user_id,
    email,
    wallets(points, gold_enabled)
  `);

  if (emailSearch) query = query.ilike("email", `%${emailSearch}%`);

  const { data } = await query;
  if (!data || data.length === 0) {
    box.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†";
    return;
  }

  box.innerHTML = "";
  data.forEach(u => {
    box.innerHTML += `
      <div class="small">
        ğŸ“§ ${u.email}<br>
        ğŸ†” ${u.user_id}<br>
        ğŸ’° ${u.wallets?.points || 0} Ù†Ù‚Ø·Ø©<br>
        ğŸª™ ${u.wallets?.gold_enabled ? "Ù…ÙØ¹Ù„" : "Ù…Ù‚ÙÙ„"}
        <hr>
      </div>
    `;
  });
}
loadUsers();
document.getElementById("loadUsers").onclick = loadUsers;

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· ===== */
async function updatePoints(add) {
  const userId = targetUserId.value.trim();
  const amount = Number(pointsAmount.value);
  if (!userId || amount <= 0) return alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

  const { data: wallet } = await supabase
    .from("wallets").select("points").eq("user_id", userId).single();

  const newPoints = add ? wallet.points + amount : wallet.points - amount;
  if (newPoints < 0) return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await supabase.from("wallets")
    .update({ points: newPoints })
    .eq("user_id", userId);

  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
  loadUsers();
}
addPointsBtn.onclick = () => updatePoints(true);
removePointsBtn.onclick = () => updatePoints(false);

/* ===== ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ ===== */
enableGoldBtn.onclick = async () => {
  await supabase.from("wallets")
    .update({ gold_enabled: true })
    .eq("user_id", goldUserId.value.trim());
  alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„");
  loadUsers();
};

disableGoldBtn.onclick = async () => {
  await supabase.from("wallets")
    .update({ gold_enabled: false })
    .eq("user_id", goldUserId.value.trim());
  alert("ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù");
  loadUsers();
};

/* ===== Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø´Ù…ÙˆØ¹ ===== */
async function insertCandle(o,h,l,c){
  await supabase.from("gold_candles").insert({
    open:o, high:h, low:l, close:c
  });
}

async function lastCandle(){
  const { data } = await supabase
    .from("gold_candles")
    .select("*")
    .order("created_at",{ascending:false})
    .limit(1)
    .single();
  return data;
}

addCandleBtn.onclick = async ()=>{
  await insertCandle(
    Number(cOpen.value),
    Number(cHigh.value),
    Number(cLow.value),
    Number(cClose.value)
  );
  alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù…Ø¹Ø©");
};

pumpGoldBtn.onclick = async ()=>{
  const c = await lastCandle();
  const move = Math.random()*5+1;
  await insertCandle(c.close, c.close+move, c.close-1, c.close+move);
  alert("ğŸ“ˆ Ø±ÙØ¹ Ø§Ù„Ø³Ø¹Ø±");
};

dumpGoldBtn.onclick = async ()=>{
  const c = await lastCandle();
  const move = Math.random()*5+1;
  await insertCandle(c.close, c.close+1, c.close-move, c.close-move);
  alert("ğŸ“‰ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±");
};
</script>

</body>
</html>
