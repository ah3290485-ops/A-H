<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€“ Ø§Ù„Ø´Ø­Ù† â€“ Ø§Ù„Ø³Ø­Ø¨</p>
    </div>
  </div>

  <div class="card">
    <h3>Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</h3>

    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
    <input id="adTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ø¹Ù„Ø§Ù† ÙŠÙˆØªÙŠÙˆØ¨">

    <label>Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨</label>
    <input id="adUrl" type="text" placeholder="https://youtube.com/...">

    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</label>
    <input id="adPoints" type="number" value="3">

    <div style="height:10px"></div>
    <button id="addAdBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
  </div>

  <div class="card">
    <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="deposits">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <div class="card">
    <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div id="withdrawals">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <div class="card">
    <a href="dashboard.html" class="btn btn-ghost">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</a>
  </div>
</div>

<script type="module">
  import { supabase } from "./assets/supabaseClient.js";

  // ğŸ” Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (Ø­Ø· Ø¥ÙŠÙ…ÙŠÙ„Ùƒ ÙÙ‚Ø·)
  const ADMIN_EMAILS = [
    "am.alsus1995@gmail.com"
  ];

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    window.location.href = "login.html";
  }

  if (!ADMIN_EMAILS.includes(user.email)) {
    alert("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·");
    window.location.href = "dashboard.html";
  }

  // ======================
  // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†
  // ======================
  document.getElementById("addAdBtn").onclick = async () => {
    const title = adTitle.value.trim();
    const url = adUrl.value.trim();
    const points = Number(adPoints.value);

    if (!title || !url || !points) {
      alert("Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      return;
    }

    await supabase.from("ads").insert({
      title,
      youtube_url: url,
      reward_points: points,
      is_active: true
    });

    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    adTitle.value = "";
    adUrl.value = "";
    adPoints.value = 3;

    loadDeposits();
    loadWithdrawals();
  };

  // ======================
  // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†
  // ======================
  async function loadDeposits() {
    const box = document.getElementById("deposits");
    const { data } = await supabase
      .from("deposits")
      .select("*")
      .eq("status", "pending");

    if (!data || data.length === 0) {
      box.innerHTML = "<p class='small'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
      return;
    }

    box.innerHTML = "";
    data.forEach(d => {
      const div = document.createElement("div");
      div.innerHTML = `
        <b>#${d.id}</b> â€” ${d.amount_usd}$<br>
        <button class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <hr>
      `;

      div.querySelector("button").onclick = async () => {
        await supabase.from("deposits")
          .update({ status: "approved" })
          .eq("id", d.id);

        const { data: wallet } = await supabase
          .from("wallets")
          .select("points")
          .eq("user_id", d.user_id)
          .single();

        await supabase.from("wallets")
          .update({ points: (wallet.points || 0) + d.amount_usd })
          .eq("user_id", d.user_id);

        loadDeposits();
      };

      box.appendChild(div);
    });
  }

  // ======================
  // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨
  // ======================
  async function loadWithdrawals() {
    const box = document.getElementById("withdrawals");
    const { data } = await supabase
      .from("withdrawals")
      .select("*")
      .eq("status", "pending");

    if (!data || data.length === 0) {
      box.innerHTML = "<p class='small'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
      return;
    }

    box.innerHTML = "";
    data.forEach(w => {
      const div = document.createElement("div");
      div.innerHTML = `
        <b>#${w.id}</b> â€” ${w.points} Ù†Ù‚Ø·Ø©<br>
        <button class="btn btn-primary">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
        <hr>
      `;

      div.querySelector("button").onclick = async () => {
        await supabase.from("withdrawals")
          .update({ status: "paid" })
          .eq("id", w.id);

        loadWithdrawals();
      };

      box.appendChild(div);
    });
  }

  loadDeposits();
  loadWithdrawals();
</script>

</body>
</html>
