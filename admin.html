<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <p class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€“ Ø§Ù„Ø´Ø­Ù† â€“ Ø§Ù„Ø³Ø­Ø¨</p>
    </div>
  </div>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† -->
  <div class="card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</h3>

    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
    <input id="adTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ø¹Ù„Ø§Ù† ÙŠÙˆØªÙŠÙˆØ¨">

    <label>Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨</label>
    <input id="adUrl" type="text" placeholder="https://youtube.com/...">

    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</label>
    <input id="adPoints" type="number" value="3">

    <div style="height:10px"></div>
    <button id="addAdBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
  </div>

  <!-- Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
  <div class="card">
    <h3>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
    <div id="adsList" class="small">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <div id="depositsList" class="small">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h3>
    <div id="withdrawalsList" class="small">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <div class="card">
    <a href="dashboard.html" class="btn btn-ghost">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</a>
  </div>
</div>

<script type="module">
  import { supabase } from "./assets/supabaseClient.js";

  // ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
  const ADMIN_EMAILS = ["am.alsus1995@gmail.com"];

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) window.location.href = "login.html";

  if (!ADMIN_EMAILS.includes(user.email)) {
    alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
    window.location.href = "dashboard.html";
  }

  // ================= Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† =================
  document.getElementById("addAdBtn").onclick = async () => {
    const title = adTitle.value.trim();
    const url = adUrl.value.trim();
    const points = Number(adPoints.value);

    if (!title || !url || !points) {
      alert("Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      return;
    }

    await supabase.from("ads").insert({
      title,
      youtube_url: url,
      reward_points: points,
      is_active: true
    });

    adTitle.value = "";
    adUrl.value = "";
    adPoints.value = 3;

    loadAds();
  };

  // ================= Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª =================
  async function loadAds() {
    const box = document.getElementById("adsList");
    const { data } = await supabase.from("ads").select("*").order("id",{ascending:false});

    if (!data || data.length === 0) {
      box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
      return;
    }

    box.innerHTML = "";
    data.forEach(ad => {
      const div = document.createElement("div");
      div.innerHTML = `
        <b>${ad.title}</b><br>
        Ù†Ù‚Ø§Ø·: ${ad.reward_points}<br>
        Ø§Ù„Ø­Ø§Ù„Ø©: ${ad.is_active ? "Ù…ÙØ¹Ù„" : "Ù…ÙˆÙ‚Ù"}<br>
        <button class="btn btn-ghost">${ad.is_active ? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"}</button>
        <hr>
      `;

      div.querySelector("button").onclick = async () => {
        await supabase.from("ads")
          .update({ is_active: !ad.is_active })
          .eq("id", ad.id);
        loadAds();
      };

      box.appendChild(div);
    });
  }

  // ================= Ø§Ù„Ø´Ø­Ù† =================
  async function loadDeposits() {
    const box = document.getElementById("depositsList");
    const { data } = await supabase.from("deposits").select("*").eq("status","pending");

    if (!data || data.length === 0) {
      box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
      return;
    }

    box.innerHTML = "";
    data.forEach(d => {
      const div = document.createElement("div");
      div.innerHTML = `
        ${d.amount_usd}$ â€“ ${d.txid || "Ø¨Ø¯ÙˆÙ† TXID"}<br>
        <button class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <hr>
      `;

      div.querySelector("button").onclick = async () => {
        await supabase.from("deposits")
          .update({ status:"approved" })
          .eq("id", d.id);

        const { data: wallet } = await supabase
          .from("wallets")
          .select("points")
          .eq("user_id", d.user_id)
          .single();

        await supabase.from("wallets")
          .update({ points:(wallet.points||0)+d.amount_usd })
          .eq("user_id", d.user_id);

        loadDeposits();
      };

      box.appendChild(div);
    });
  }

  // ================= Ø§Ù„Ø³Ø­Ø¨ =================
  async function loadWithdrawals() {
    const box = document.getElementById("withdrawalsList");
    const { data } = await supabase.from("withdrawals").select("*").eq("status","pending");

    if (!data || data.length === 0) {
      box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
      return;
    }

    box.innerHTML = "";
    data.forEach(w => {
      const div = document.createElement("div");
      div.innerHTML = `
        ${w.points} Ù†Ù‚Ø·Ø© â€“ ${w.wallet_address}<br>
        <button class="btn btn-primary">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
        <hr>
      `;

      div.querySelector("button").onclick = async () => {
        await supabase.from("withdrawals")
          .update({ status:"paid" })
          .eq("id", w.id);
        loadWithdrawals();
      };

      box.appendChild(div);
    });
  }

  loadAds();
  loadDeposits();
  loadWithdrawals();
</script>

</body>
</html>
