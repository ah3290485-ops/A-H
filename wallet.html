<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ูุญูุธุชู</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>๐ ุงูุดุญู ุงูุฃูุชููุงุชููู</h1>
      <p class="small">USDT โ TRC20</p>
    </div>
  </div>

  <div class="card">
    <p class="small">ุญููู USDT (TRC20) ุฅูู ุงูุนููุงู:</p>
    <div style="font-weight:800;word-break:break-all">
      TPNoGerv1EMBSdrs9Yca93eCQUVsoNiRvq
    </div>
  </div>

  <div class="card">
    <label class="small">ุงููุจูุบ (USDT)</label>
    <input id="amount" type="number" placeholder="ูุซุงู: 100">

    <div style="height:10px"></div>

    <label class="small">TXID</label>
    <input id="txid" type="text" placeholder="Transaction Hash">

    <div style="height:15px"></div>

    <button id="checkBtn" class="btn btn-primary">
      ๐ ุชุญูู ูุดุญู
    </button>
  </div>

  <div id="msg" class="small"></div>
</div>

<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">๐<div>ุงูุฑุฆูุณูุฉ</div></a>
    <a class="nav-item active" href="wallet.html">๐<div>ูุญูุธุชู</div></a>
    <a class="nav-item" href="ads.html">๐บ<div>ุงูุฅุนูุงูุงุช</div></a>
    <a class="nav-item" href="profile.html">๐ค<div>ุงูููู ุงูุดุฎุตู</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

const OWNER_ADDRESS = "TPNoGerv1EMBSdrs9Yca93eCQUVsoNiRvq";

/* ุชุญูู ุชุณุฌูู ุงูุฏุฎูู */
const { data: { user } } = await supabase.auth.getUser();
if (!user) window.location.href = "login.html";

const msg = document.getElementById("msg");

document.getElementById("checkBtn").onclick = async () => {
  msg.innerText = "โณ ุฌุงุฑู ุงูุชุญูู...";
  const amount = Number(document.getElementById("amount").value);
  const txid = document.getElementById("txid").value.trim();

  if (!amount || amount < 1 || !txid) {
    msg.innerText = "โ ุฃุฏุฎู ุงููุจูุบ ู TXID ุจุดูู ุตุญูุญ";
    return;
  }

  /* ููุน ุชูุฑุงุฑ TXID */
  const { data: used } = await supabase
    .from("deposits")
    .select("id")
    .eq("txid", txid)
    .single();

  if (used) {
    msg.innerText = "โ TXID ูุณุชุฎุฏู ูุณุจูุงู";
    return;
  }

  /* ูุญุต TXID ูู Tronscan */
  const res = await fetch(
    `https://apilist.tronscanapi.com/api/transaction-info?hash=${txid}`
  );
  const data = await res.json();

  if (!data || !data.contractData) {
    msg.innerText = "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุชุญููู";
    return;
  }

  const to = data.contractData.to_address;
  const value = Number(data.contractData.amount) / 1e6; // USDT

  if (to !== OWNER_ADDRESS) {
    msg.innerText = "โ ุงูุนููุงู ุงููุณุชูู ุบูุฑ ุตุญูุญ";
    return;
  }

  if (value < amount) {
    msg.innerText = "โ ุงููุจูุบ ุงููุญููู ุฃูู ูู ุงููุทููุจ";
    return;
  }

  /* ุฌูุจ ุงููุญูุธุฉ */
  let { data: wallet } = await supabase
    .from("wallets")
    .select("points, last_deposit, first_deposit_at")
    .eq("user_id", user.id)
    .single();

  if (!wallet) {
    await supabase.from("wallets").insert({
      user_id: user.id,
      points: 0,
      last_deposit: 0,
      first_deposit_at: new Date().toISOString()
    });
    wallet = { points: 0, last_deposit: 0, first_deposit_at: new Date().toISOString() };
  }

  const updates = {
    points: wallet.points + amount,
    last_deposit: amount
  };

  if (!wallet.first_deposit_at) {
    updates.first_deposit_at = new Date().toISOString();
  }

  await supabase
    .from("wallets")
    .update(updates)
    .eq("user_id", user.id);

  /* ุญูุธ ุงูุฅูุฏุงุน */
  await supabase.from("deposits").insert({
    user_id: user.id,
    amount_usd: amount,
    txid,
    status: "approved"
  });

  msg.innerText = "โ ุชู ุงูุดุญู ุจูุฌุงุญ";
};
</script>

</body>
</html>
