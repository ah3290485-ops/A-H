<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ูุญูุธุชู</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>๐ ุงููุญูุธุฉ</h1>
      <p class="small">ุดุญู ูุณุญุจ USDT (TRC20)</p>
    </div>
  </div>

  <!-- ๐ ุงูุดุญู -->
  <div class="card">
    <h3>๐ ุฃุดุญู ูุงุฑุจุญ</h3>
    <p class="small">ุญููู USDT (TRC20) ุฅูู ุงูุนููุงู:</p>
    <div style="font-weight:800;word-break:break-all">
      TPNoGerv1EMBSdrs9Yca93eCQUVsoNiRvq
    </div>
  </div>

  <div class="card">
    <label class="small">ุงููุจูุบ (USDT)</label>
    <input id="amount" type="number" placeholder="ูุซุงู: 100">

    <div style="height:10px"></div>

    <label class="small">TXID</label>
    <input id="txid" type="text" placeholder="Transaction Hash">

    <div style="height:15px"></div>

    <button id="checkBtn" class="btn btn-primary">๐ ุชุญูู ูุดุญู</button>
    <div id="msg" class="small" style="margin-top:10px"></div>
  </div>

  <!-- ๐ธ ุงูุณุญุจ -->
  <div class="card">
    <h3>๐ธ ุณุญุจ ุงูุฑุตูุฏ</h3>

    <label class="small">ุนุฏุฏ ุงูููุงุท</label>
    <input id="wdPoints" type="number" placeholder="ูุซุงู: 50">

    <div style="height:10px"></div>

    <label class="small">ุนููุงู ุงููุญูุธุฉ (USDT TRC20)</label>
    <input id="wdAddress" type="text" placeholder="T...">

    <div style="height:15px"></div>

    <button id="withdrawBtn" class="btn btn-danger">๐ค ุทูุจ ุณุญุจ</button>

    <p class="small" style="margin-top:10px;opacity:.7">
      โณ ุงูุณุญุจ ูุชุงุญ ุจุนุฏ 20 ููู ูู ุฃูู ุดุญู
    </p>
  </div>

</div>

<!-- ุดุฑูุท ุงูุชููู -->
<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">๐<div>ุงูุฑุฆูุณูุฉ</div></a>
    <a class="nav-item active" href="wallet.html">๐<div>ูุญูุธุชู</div></a>
    <a class="nav-item" href="ads.html">๐บ<div>ุงูุฅุนูุงูุงุช</div></a>
    <a class="nav-item" href="profile.html">๐ค<div>ุงูููู ุงูุดุฎุตู</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

const OWNER_ADDRESS = "TPNoGerv1EMBSdrs9Yca93eCQUVsoNiRvq";

/* ===== ุชุญูู ุชุณุฌูู ุงูุฏุฎูู ===== */
const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "login.html";

const msg = document.getElementById("msg");

/* ===== ุฅุฎูุงุก ุงูุฅูููู ===== */
function maskEmail(email) {
  const [name, domain] = email.split("@");
  return name.slice(0,2) + "*****" + name.slice(-2) + "@" + domain;
}

/* ===== ุงูุดุญู ===== */
document.getElementById("checkBtn").onclick = async () => {
  msg.innerText = "โณ ุฌุงุฑู ุงูุชุญูู...";
  const amount = Number(document.getElementById("amount").value);
  const txid = document.getElementById("txid").value.trim();

  if (!amount || amount < 1 || !txid) {
    msg.innerText = "โ ุฃุฏุฎู ุงููุจูุบ ู TXID";
    return;
  }

  const { data: used } = await supabase
    .from("deposits")
    .select("id")
    .eq("txid", txid)
    .single();

  if (used) {
    msg.innerText = "โ TXID ูุณุชุฎุฏู ูุณุจูุงู";
    return;
  }

  const res = await fetch(
    `https://apilist.tronscanapi.com/api/transaction-info?hash=${txid}`
  );
  const data = await res.json();

  if (!data?.contractData) {
    msg.innerText = "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุชุญููู";
    return;
  }

  if (data.contractData.to_address !== OWNER_ADDRESS) {
    msg.innerText = "โ ุงูุนููุงู ุบูุฑ ุตุญูุญ";
    return;
  }

  const value = Number(data.contractData.amount) / 1e6;
  if (value < amount) {
    msg.innerText = "โ ุงููุจูุบ ุฃูู ูู ุงููุทููุจ";
    return;
  }

  let { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  const newPoints = Number(wallet.points || 0) + amount;

  await supabase.from("wallets")
    .update({ points: newPoints })
    .eq("user_id", user.id);

  await supabase.from("deposits").insert({
    user_id: user.id,
    amount,
    txid
  });

  // ๐ ูุดุงุท ุนุงู (ุดุญู)
  await supabase.from("public_activity").insert({
    user_id: user.id,
    email: maskEmail(user.email),
    action: "ุฅูุฏุงุน",
    amount
  });

  msg.innerText = "โ ุชู ุงูุดุญู ุจูุฌุงุญ";
};

/* ===== ุงูุณุญุจ ===== */
document.getElementById("withdrawBtn").onclick = async () => {
  const points = Number(document.getElementById("wdPoints").value);
  const address = document.getElementById("wdAddress").value.trim();

  if (!points || points <= 0 || !address) {
    alert("ุฃุฏุฎู ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ");
    return;
  }

  await supabase.from("withdrawals").insert({
    user_id: user.id,
    points,
    address
  });

  // ๐ ูุดุงุท ุนุงู (ุณุญุจ)
  await supabase.from("public_activity").insert({
    user_id: user.id,
    email: maskEmail(user.email),
    action: "ุณุญุจ",
    amount: points
  });

  alert("โ ุชู ุฅุฑุณุงู ุทูุจ ุงูุณุญุจ");
};
</script>

</body>
</html>
