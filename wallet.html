<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù…Ø­ÙØ¸ØªÙŠ</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Ù…Ø­ÙØ¸ØªÙŠ</h1>
      <p class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØµÙŠØ¯ (Ø´Ø­Ù† / Ø³Ø­Ø¨)</p>
    </div>
  </div>

  <!-- Ø§Ù„Ø±ØµÙŠØ¯ -->
  <div class="card">
    <div class="row">
      <div>
        <div class="small">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
        <div id="points" style="font-size:28px;font-weight:800">0</div>
      </div>
      <div>
        <div class="badge warn">1$ = 1 Ù†Ù‚Ø·Ø©</div>
      </div>
    </div>
  </div>

  <!-- Ø·Ù„Ø¨ Ø´Ø­Ù† -->
  <div class="card">
    <h3>Ø·Ù„Ø¨ Ø´Ø­Ù†</h3>

    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</label>
    <input id="depAmount" type="number" placeholder="Ù…Ø«Ø§Ù„: 50">

    <label>TXID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="depTxid" type="text" placeholder="Transaction ID">

    <div style="height:10px"></div>
    <button id="btnDeposit" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
  </div>

  <!-- Ø·Ù„Ø¨ Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>Ø·Ù„Ø¨ Ø³Ø­Ø¨</h3>

    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</label>
    <input id="wdPoints" type="number" placeholder="Ù…Ø«Ø§Ù„: 20">

    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
    <input id="wdAddress" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ">

    <div style="height:10px"></div>
    <button id="btnWithdraw" class="btn btn-ghost">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
  </div>
</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ -->
<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">
      <div class="ico">ğŸ </div>
      <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    </a>
    <a class="nav-item" href="ads.html">
      <div class="ico">ğŸ“º</div>
      <div>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
    </a>
    <a class="nav-item active" href="wallet.html">
      <div class="ico">ğŸ‘›</div>
      <div>Ù…Ø­ÙØ¸ØªÙŠ</div>
    </a>
    <a class="nav-item" href="profile.html">
      <div class="ico">ğŸ‘¤</div>
      <div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
    </a>
  </div>
</nav>

<script type="module">
  import { supabase } from "./assets/supabaseClient.js";

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "login.html";
  }

  // Ø¬Ù„Ø¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ÙØ¸Ø©
  let { data: wallet } = await supabase
    .from("wallets")
    .select("points")
    .eq("user_id", user.id)
    .single();

  if (!wallet) {
    await supabase.from("wallets").insert({
      user_id: user.id,
      points: 0
    });
    wallet = { points: 0 };
  }

  document.getElementById("points").innerText = wallet.points;

  // Ø·Ù„Ø¨ Ø´Ø­Ù†
  document.getElementById("btnDeposit").onclick = async () => {
    const amount = Number(document.getElementById("depAmount").value);
    const txid = document.getElementById("depTxid").value.trim();

    if (!amount || amount <= 0) {
      alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
      return;
    }

    await supabase.from("deposits").insert({
      user_id: user.id,
      amount_usd: amount,
      txid,
      status: "pending"
    });

    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†");
    location.reload();
  };

  // Ø·Ù„Ø¨ Ø³Ø­Ø¨
  document.getElementById("btnWithdraw").onclick = async () => {
    const points = Number(document.getElementById("wdPoints").value);
    const address = document.getElementById("wdAddress").value.trim();

    if (!points || points <= 0 || !address) {
      alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      return;
    }

    if (points > wallet.points) {
      alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ");
      return;
    }

    await supabase.from("withdrawals").insert({
      user_id: user.id,
      points,
      wallet_address: address,
      status: "pending"
    });

    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨");
    location.reload();
  };
</script>

</body>
</html>
