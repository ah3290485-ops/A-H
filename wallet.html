<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù…Ø­ÙØ¸ØªÙŠ</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ‘› Ø§Ù„Ù…Ø­ÙØ¸Ø©</h1>
      <p class="small">Ø´Ø­Ù† ÙˆØ³Ø­Ø¨ USDT (TRC20)</p>
    </div>
  </div>

  <!-- ğŸ”„ Ø§Ù„Ø´Ø­Ù† -->
  <div class="card">
    <h3>ğŸ”„ Ø£Ø´Ø­Ù† ÙˆØ§Ø±Ø¨Ø­</h3>
    <p class="small">Ø­ÙˆÙ‘Ù„ USDT (TRC20) Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</p>
    <div style="font-weight:800;word-break:break-all">
      TPNoGerv1EMBSdrs9Yca93eCQUVsoNiRvq
    </div>
  </div>

  <div class="card">
    <label class="small">Ø§Ù„Ù…Ø¨Ù„Øº (USDT)</label>
    <input id="amount" type="number" placeholder="Ù…Ø«Ø§Ù„: 100">

    <div style="height:10px"></div>

    <label class="small">TXID</label>
    <input id="txid" type="text" placeholder="Transaction Hash">

    <div style="height:15px"></div>

    <button id="checkBtn" class="btn btn-primary">ğŸ”„ ØªØ­Ù‚Ù‚ ÙˆØ´Ø­Ù†</button>
    <div id="msg" class="small" style="margin-top:10px"></div>
  </div>

  <!-- ğŸ’¸ Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="card">
    <h3>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</h3>

    <label class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</label>
    <input id="wdPoints" type="number" placeholder="Ù…Ø«Ø§Ù„: 50">

    <div style="height:10px"></div>

    <label class="small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© (USDT TRC20)</label>
    <input id="wdAddress" type="text" placeholder="T...">

    <div style="height:15px"></div>

    <button id="withdrawBtn" class="btn btn-danger">ğŸ“¤ Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>

    <p class="small" style="margin-top:10px;opacity:.7">
      â³ Ø§Ù„Ø³Ø­Ø¨ Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ 20 ÙŠÙˆÙ… Ù…Ù† Ø£ÙˆÙ„ Ø´Ø­Ù†
    </p>
  </div>

  <!-- ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª -->
  <div class="card">
    <h3>ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
    <div id="transactionsBox">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a class="nav-item active" href="wallet.html">ğŸ‘›<div>Ù…Ø­ÙØ¸ØªÙŠ</div></a>
    <a class="nav-item" href="ads.html">ğŸ“º<div>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div></a>
    <a class="nav-item" href="profile.html">ğŸ‘¤<div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

const OWNER_ADDRESS = "TPNoGerv1EMBSdrs9Yca93eCQUVsoNiRvq";

/* ===== ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
const { data: { user } } = await supabase.auth.getUser();
if (!user) window.location.href = "login.html";

const msg = document.getElementById("msg");

/* ===== Ø§Ù„Ø´Ø­Ù† ===== */
document.getElementById("checkBtn").onclick = async () => {
  msg.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
  const amount = Number(document.getElementById("amount").value);
  const txid = document.getElementById("txid").value.trim();

  if (!amount || amount < 1 || !txid) {
    msg.innerText = "âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ùˆ TXID";
    return;
  }

  const { data: used } = await supabase
    .from("deposits")
    .select("id")
    .eq("txid", txid)
    .single();

  if (used) {
    msg.innerText = "âŒ TXID Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹";
    return;
  }

  const res = await fetch(
    `https://apilist.tronscanapi.com/api/transaction-info?hash=${txid}`
  );
  const data = await res.json();

  if (!data || !data.contractData) {
    msg.innerText = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ÙˆÙŠÙ„";
    return;
  }

  if (data.contractData.to_address !== OWNER_ADDRESS) {
    msg.innerText = "âŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­";
    return;
  }

  const value = Number(data.contractData.amount) / 1e6;
  if (value < amount) {
    msg.innerText = "âŒ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨";
    return;
  }

  let { data: wallet } = await supabase
    .from("wallets")
    .select("points, first_deposit_at")
    .eq("user_id", user.id)
    .single();

  if (!wallet) {
    wallet = { points: 0, first_deposit_at: new Date().toISOString() };
    await supabase.from("wallets").insert({
      user_id: user.id,
      points: 0,
      first_deposit_at: wallet.first_deposit_at
    });
  }

  await supabase.from("wallets").update({
    points: wallet.points + amount
  }).eq("user_id", user.id);

  await supabase.from("deposits").insert({
    user_id: user.id,
    amount_usd: amount,
    txid: txid,
    status: "approved"
  });

  await supabase.from("transactions").insert({
    user_id: user.id,
    type: "deposit",
    amount: amount,
    description: "Ø´Ø­Ù† Ø±ØµÙŠØ¯ USDT"
  });

  msg.innerText = "âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­";
  loadTransactions();
};

/* ===== Ø§Ù„Ø³Ø­Ø¨ ===== */
document.getElementById("withdrawBtn").onclick = async () => {
  const points = Number(document.getElementById("wdPoints").value);
  const address = document.getElementById("wdAddress").value.trim();

  if (!points || !address) {
    alert("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const { data: wallet } = await supabase
    .from("wallets")
    .select("points, first_deposit_at")
    .eq("user_id", user.id)
    .single();

  const diffDays = (new Date() - new Date(wallet.first_deposit_at)) / (1000*60*60*24);
  if (diffDays < 35) {
    alert(`â³ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯ ${Math.ceil(35 - diffDays)} ÙŠÙˆÙ…`);
    return;
  }

  if (points > wallet.points) {
    alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");
    return;
  }

  await supabase.from("withdrawals").insert({
    user_id: user.id,
    points,
    wallet_address: address,
    status: "pending"
  });

  await supabase.from("transactions").insert({
    user_id: user.id,
    type: "withdraw",
    amount: points,
    description: "Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù†Ù‚Ø§Ø·"
  });

  alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨");
  location.reload();
};

/* ===== Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ===== */
async function loadTransactions() {
  const box = document.getElementById("transactionsBox");

  const { data } = await supabase
    .from("transactions")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (!data || data.length === 0) {
    box.innerHTML = "<div class='small'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯</div>";
    return;
  }

  box.innerHTML = "";
  data.forEach(tx => {
    box.innerHTML += `
      <div class="small">
        ${icon(tx.type)} <b>${tx.description}</b><br>
        ğŸ’° ${tx.amount} Ù†Ù‚Ø·Ø©<br>
        ğŸ•’ ${new Date(tx.created_at).toLocaleString()}
        <hr>
      </div>
    `;
  });
}

function icon(type) {
  if (type === "deposit") return "ğŸ’³";
  if (type === "withdraw") return "ğŸ’¸";
  if (type === "admin_add") return "â•";
  if (type === "admin_remove") return "â–";
  return "ğŸ”¹";
}

loadTransactions();
</script>

</body>
</html>
