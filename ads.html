<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">

  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ğŸ“º Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h1>
      <p class="small">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¨Ø­ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©</p>
    </div>
  </div>

  <div id="adsBox">ØªØ­Ù…ÙŠÙ„...</div>

</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a class="nav-item active" href="ads.html">ğŸ“º<div>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div></a>
    <a class="nav-item" href="wallet.html">ğŸ‘›<div>Ù…Ø­ÙØ¸ØªÙŠ</div></a>
    <a class="nav-item" href="profile.html">ğŸ‘¤<div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =========================
   ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
========================= */
const { data: { user } } = await supabase.auth.getUser();
if (!user) window.location.href = "login.html";

const box = document.getElementById("adsBox");

/* =========================
   Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ù†Ù‚Ø§Ø· ÙÙ‚Ø·)
========================= */
const { data: wallet } = await supabase
  .from("wallets")
  .select("points")
  .eq("user_id", user.id)
  .single();

/* =========================
   Ù…Ù†Ø¹ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø·
========================= */
if (!wallet || wallet.points <= 0) {
  box.innerHTML = `
    <div class="card">
      <h3>ğŸ”’ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù‚ÙÙ„Ø©</h3>
      <p class="small">
        ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù†Ù‚Ø§Ø· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.<br>
        ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø´Ø­Ù† Ø£Ùˆ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.
      </p>
    </div>
  `;
  throw new Error("No points");
}

/* =========================
   Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ
   ÙƒÙ„ 100 Ù†Ù‚Ø·Ø© = 3 Ù†Ù‚Ø§Ø·
========================= */
const dailyReward = Math.floor(wallet.points / 100) * 3;

if (dailyReward <= 0) {
  box.innerHTML = `
    <div class="card">
      <h3>âš ï¸ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ</h3>
      <p class="small">
        Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±Ø¨Ø­ Ù‡Ùˆ Ø§Ù…ØªÙ„Ø§Ùƒ 100 Ù†Ù‚Ø·Ø©
      </p>
    </div>
  `;
  throw new Error("Not enough points");
}

/* =========================
   Ø¬Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù† Ù…ÙØ¹Ù‘Ù„ ÙˆØ§Ø­Ø¯
========================= */
const { data: ads } = await supabase
  .from("ads")
  .select("*")
  .eq("is_active", true)
  .limit(1);

if (!ads || ads.length === 0) {
  box.innerHTML = `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
  throw new Error("No ads");
}

const ad = ads[0];

/* =========================
   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¢Ø®Ø± Ù…Ø´Ø§Ù‡Ø¯Ø© (24 Ø³Ø§Ø¹Ø©)
========================= */
const { data: view } = await supabase
  .from("ad_views")
  .select("*")
  .eq("user_id", user.id)
  .eq("ad_id", ad.id)
  .single();

let canClaim = true;
let message = "";

if (view) {
  const last = new Date(view.last_view);
  const now = new Date();
  const diff = (now - last) / (1000 * 60 * 60);

  if (diff < 24) {
    canClaim = false;
    const remain = Math.ceil(24 - diff);
    message = `â³ Ù…ØªØ¨Ù‚ÙŠ ${remain} Ø³Ø§Ø¹Ø©`;
  }
}

/* =========================
   Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
========================= */
box.innerHTML = `
  <div class="card">
    <h3>${ad.title}</h3>

    <a href="${ad.youtube_url}" target="_blank" class="btn btn-ghost">
      â–¶ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
    </a>

    <div style="height:10px"></div>

    <button id="claimBtn" class="btn btn-primary" ${!canClaim ? "disabled" : ""}>
      ${canClaim ? `Ø£Ø®Ø° ${dailyReward} Ù†Ù‚Ø§Ø·` : message}
    </button>

    <p class="small" style="margin-top:10px;opacity:.7;text-align:center">
      ğŸ’± ÙƒÙ„ 100 Ù†Ù‚Ø·Ø© = 3 Ù†Ù‚Ø§Ø· Ø±Ø¨Ø­ ÙŠÙˆÙ…ÙŠ
    </p>
  </div>
`;

/* =========================
   Ø£Ø®Ø° Ø§Ù„Ù†Ù‚Ø§Ø·
========================= */
if (canClaim) {
  document.getElementById("claimBtn").onclick = async () => {

    await supabase
      .from("wallets")
      .update({ points: wallet.points + dailyReward })
      .eq("user_id", user.id);

    if (view) {
      await supabase
        .from("ad_views")
        .update({ last_view: new Date() })
        .eq("id", view.id);
    } else {
      await supabase
        .from("ad_views")
        .insert({
          user_id: user.id,
          ad_id: ad.id
        });
    }

    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·");
    location.reload();
  };
}
</script>

</body>
</html>
