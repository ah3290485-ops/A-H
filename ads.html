<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h1>
      <p class="small">ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ø®Ø° Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 24 Ø³Ø§Ø¹Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø­Ù†)</p>
    </div>
  </div>

  <div id="adsList"></div>
</div>

<nav class="bottom-nav">
  <div class="nav-wrap">
    <a class="nav-item" href="dashboard.html">ğŸ <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a class="nav-item active" href="ads.html">ğŸ“º<div>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div></a>
    <a class="nav-item" href="wallet.html">ğŸ‘›<div>Ù…Ø­ÙØ¸ØªÙŠ</div></a>
    <a class="nav-item" href="profile.html">ğŸ‘¤<div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div></a>
  </div>
</nav>

<script type="module">
import { supabase } from "./assets/supabaseClient.js";

/* =========================
   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
========================= */
const { data: { user } } = await supabase.auth.getUser();
if (!user) window.location.href = "login.html";

/* =========================
   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø­Ù†
   (Ù„Ø§ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†)
========================= */
const { data: wallet } = await supabase
  .from("wallets")
  .select("points")
  .eq("user_id", user.id)
  .single();

const box = document.getElementById("adsList");

if (!wallet || wallet.points <= 0) {
  box.innerHTML = `
    <div class="card">
      <h3>ğŸ”’ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù‚ÙÙ„Ø©</h3>
      <p class="small">
        ÙŠØ¬Ø¨ Ø´Ø­Ù† Ø­Ø³Ø§Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ø­ØªÙ‰ ØªØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆÙƒØ³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
      </p>
      <a href="wallet.html" class="btn btn-primary">
        Ø´Ø­Ù† Ø§Ù„Ø¢Ù†
      </a>
    </div>
  `;
  throw new Error("User has no balance");
}

/* =========================
   Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©
========================= */
const { data: ads } = await supabase
  .from("ads")
  .select("*")
  .eq("is_active", true);

if (!ads || ads.length === 0) {
  box.innerHTML = "<div class='card'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>";
} else {

  for (const ad of ads) {

    // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†
    const { data: view } = await supabase
      .from("ad_views")
      .select("*")
      .eq("user_id", user.id)
      .eq("ad_id", ad.id)
      .single();

    let canClaim = true;
    let msg = "";

    if (view) {
      const last = new Date(view.last_view);
      const now = new Date();
      const diffHours = (now - last) / (1000 * 60 * 60);

      if (diffHours < 24) {
        canClaim = false;
        const remaining = Math.ceil(24 - diffHours);
        msg = `ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ${remaining} Ø³Ø§Ø¹Ø©`;
      }
    }

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${ad.title}</h3>
      <a class="btn btn-ghost" target="_blank" href="${ad.youtube_url}">
        â–¶ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
      </a>
      <div style="height:10px"></div>
      <button class="btn btn-primary" ${!canClaim ? "disabled" : ""}>
        ${canClaim ? "Ø£Ø®Ø° " + ad.reward_points + " Ù†Ù‚Ø§Ø·" : msg}
      </button>
    `;

    const btn = card.querySelector("button");

    if (canClaim) {
      btn.onclick = async () => {

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
        await supabase
          .from("wallets")
          .update({ points: wallet.points + ad.reward_points })
          .eq("user_id", user.id);

        // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        if (view) {
          await supabase
            .from("ad_views")
            .update({ last_view: new Date() })
            .eq("id", view.id);
        } else {
          await supabase
            .from("ad_views")
            .insert({
              user_id: user.id,
              ad_id: ad.id
            });
        }

        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· âœ…");
        location.reload();
      };
    }

    box.appendChild(card);
  }
}
</script>

</body>
</html>
